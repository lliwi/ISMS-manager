{% extends "base.html" %}

{% block title %}{{ 'Editar' if task else 'Nueva' }} Tarea - ISMS Manager{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('tasks.index') }}">Tareas</a></li>
            <li class="breadcrumb-item active">{{ 'Editar' if task else 'Nueva Tarea' }}</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-{{ 'edit' if task else 'plus' }} me-2"></i>{{ 'Editar' if task else 'Nueva' }} Tarea</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <form method="POST" action="">
                        {{ form.hidden_tag() }}

                        <!-- Título -->
                        <div class="mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else "")) }}
                            {% if form.title.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.title.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Descripción -->
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows="4") }}
                            {% if form.description.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.description.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Categoría y Prioridad -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.category.label(class="form-label") }}
                                {{ form.category(class="form-select" + (" is-invalid" if form.category.errors else "")) }}
                                {% if form.category.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.category.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.priority.label(class="form-label") }}
                                {{ form.priority(class="form-select" + (" is-invalid" if form.priority.errors else "")) }}
                                {% if form.priority.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.priority.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Asignación -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.assigned_to_id.label(class="form-label") }}
                                {{ form.assigned_to_id(class="form-select" + (" is-invalid" if form.assigned_to_id.errors else "")) }}
                                {% if form.assigned_to_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.assigned_to_id.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.due_date.label(class="form-label") }}
                                {{ form.due_date(class="form-control" + (" is-invalid" if form.due_date.errors else "")) }}
                                {% if form.due_date.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.due_date.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Horas Estimadas -->
                        <div class="mb-3">
                            {{ form.estimated_hours.label(class="form-label") }}
                            {{ form.estimated_hours(class="form-control" + (" is-invalid" if form.estimated_hours.errors else ""), type="number", step="0.5") }}
                            {% if form.estimated_hours.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.estimated_hours.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Checklist (opcional) -->
                        <div class="mb-3">
                            <label class="form-label">Lista de Verificación (opcional)</label>
                            <small class="text-muted d-block mb-2">Una tarea por línea</small>
                            <textarea id="checklist_text" class="form-control" rows="4" placeholder="- Verificar configuración&#10;- Revisar documentación&#10;- Realizar pruebas"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Controles SOA Relacionados -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-shield-alt"></i> Controles ISO 27001 Relacionados</h6>
                    </div>
                    <div class="card-body">
                        {% if controls %}
                        <!-- Filtro de controles -->
                        <div class="mb-3">
                            <input type="text" class="form-control" id="control-filter"
                                   placeholder="🔍 Buscar controles por ID, título o categoría...">
                        </div>

                        <!-- Contador de controles -->
                        <div class="mb-2">
                            <small class="text-muted">
                                <span id="selected-count">{{ task.related_controls|length if task else 0 }}</span> controles seleccionados de
                                <span id="total-count">{{ controls|length }}</span>
                            </small>
                        </div>

                        <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                            <div class="row">
                                {% for control in controls %}
                                <div class="col-md-12 mb-2 control-item" data-control-text="{{ control.control_id|lower }} {{ control.title|lower }} {{ control.category|lower }}">
                                    <div class="form-check">
                                        <input class="form-check-input control-checkbox" type="checkbox"
                                               name="related_controls" value="{{ control.id }}"
                                               id="control_{{ control.id }}"
                                               {{ 'checked' if task and control in task.related_controls }}>
                                        <label class="form-check-label" for="control_{{ control.id }}" style="cursor: pointer;">
                                            <code class="text-primary">{{ control.control_id }}</code>
                                            <strong>{{ control.title }}</strong>
                                            <br><small class="text-muted">{{ control.category }}</small>
                                            {% if control.maturity_level != 'no_implementado' %}
                                            <span class="badge bg-info">{{ control.maturity_level_display }}</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div id="no-results" class="alert alert-warning mt-2" style="display: none;">
                            <i class="fas fa-search me-2"></i>No se encontraron controles que coincidan con la búsqueda.
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No hay controles SOA disponibles. Primero debe crear una versión SOA e importar controles.
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <!-- Botones de acción -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('tasks.index') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>{{ 'Actualizar' if task else 'Crear' }} Tarea
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar con información -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Ayuda</h6>
                </div>
                <div class="card-body">
                    <h6>Categorías ISO 27001:</h6>
                    <ul class="small">
                        <li><strong>Revisión Controles:</strong> 9.1 Seguimiento y medición</li>
                        <li><strong>Auditoría Interna:</strong> 9.2 Auditoría interna</li>
                        <li><strong>Evaluación Riesgos:</strong> 8.2 Evaluación de riesgos</li>
                        <li><strong>Revisión Políticas:</strong> 5.1 Políticas de seguridad</li>
                        <li><strong>Formación:</strong> 7.2 y 7.3 Competencia</li>
                    </ul>

                    <hr>

                    <h6>Prioridades:</h6>
                    <ul class="small">
                        <li><strong class="text-danger">Crítica:</strong> Requiere acción inmediata</li>
                        <li><strong class="text-warning">Alta:</strong> Importante, plazo corto</li>
                        <li><strong>Media:</strong> Normal, planificable</li>
                        <li><strong class="text-success">Baja:</strong> Puede esperar</li>
                    </ul>
                </div>
            </div>

            {% if task %}
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Información</h6>
                </div>
                <div class="card-body">
                    <p class="small mb-2">
                        <strong>Creada:</strong><br>
                        {{ task.created_at.strftime('%d/%m/%Y %H:%M') }}
                    </p>
                    <p class="small mb-0">
                        <strong>Última actualización:</strong><br>
                        {{ task.updated_at.strftime('%d/%m/%Y %H:%M') }}
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Procesar checklist al enviar el formulario
    document.querySelector('form').addEventListener('submit', function(e) {
        const checklistText = document.getElementById('checklist_text').value;
        if (checklistText.trim()) {
            const items = checklistText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map(line => ({
                    description: line.replace(/^[-*]\s*/, ''),
                    completed: false
                }));

            // Crear campo hidden con JSON
            const hiddenField = document.createElement('input');
            hiddenField.type = 'hidden';
            hiddenField.name = 'checklist_json';
            hiddenField.value = JSON.stringify(items);
            this.appendChild(hiddenField);
        }
    });

    // Si estamos editando y hay checklist, cargarla
    {% if task and task.checklist %}
    const checklist = {{ task.checklist|tojson }};
    const checklistLines = checklist.map(item => '- ' + item.description).join('\n');
    document.getElementById('checklist_text').value = checklistLines;
    {% endif %}

    // Filtro de controles SOA
    const filterInput = document.getElementById('control-filter');
    const controlItems = document.querySelectorAll('.control-item');
    const controlCheckboxes = document.querySelectorAll('.control-checkbox');
    const selectedCount = document.getElementById('selected-count');
    const noResults = document.getElementById('no-results');

    // Función para actualizar el contador de seleccionados
    function updateSelectedCount() {
        const checked = document.querySelectorAll('.control-checkbox:checked').length;
        if (selectedCount) {
            selectedCount.textContent = checked;
        }
    }

    // Filtro de controles
    if (filterInput) {
        filterInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            let visibleCount = 0;

            controlItems.forEach(item => {
                const controlText = item.getAttribute('data-control-text');

                if (controlText.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // Mostrar/ocultar mensaje de sin resultados
            if (noResults) {
                if (visibleCount === 0 && searchTerm !== '') {
                    noResults.style.display = 'block';
                } else {
                    noResults.style.display = 'none';
                }
            }
        });
    }

    // Actualizar contador cuando se marcan/desmarcan checkboxes
    controlCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });

    // Inicializar contador
    updateSelectedCount();
</script>
{% endblock %}

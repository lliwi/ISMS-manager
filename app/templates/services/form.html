{% extends "base.html" %}
{% block title %}{% if action == 'create' %}Nuevo Servicio{% else %}Editar Servicio{% endif %}{% endblock %}

{% block extra_css %}
<style>
    .asset-item, .service-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        transition: background-color 0.2s, border-color 0.2s;
    }

    .asset-item:hover, .service-item:hover {
        background-color: #f8f9fa;
        border-color: #adb5bd;
    }

    .asset-item input[type="checkbox"]:checked + label,
    .service-item input[type="checkbox"]:checked + label {
        font-weight: 500;
    }

    .asset-item input[type="checkbox"]:checked,
    .service-item input[type="checkbox"]:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .asset-selection-container, .service-selection-container {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.5rem;
    }

    .asset-selection-container:empty::before {
        content: 'No hay activos disponibles';
        color: #6c757d;
        font-style: italic;
        display: block;
        padding: 1rem;
        text-align: center;
    }

    .service-selection-container:empty::before {
        content: 'No hay servicios disponibles';
        color: #6c757d;
        font-style: italic;
        display: block;
        padding: 1rem;
        text-align: center;
    }

    .dependency-type-container {
        background-color: #f8f9fa;
        padding: 0.5rem;
        border-radius: 0.25rem;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('services.index') }}">Servicios</a></li>
                    {% if action == 'edit' %}
                    <li class="breadcrumb-item"><a href="{{ url_for('services.detail', service_id=service.id) }}">{{ service.service_code }}</a></li>
                    <li class="breadcrumb-item active">Editar</li>
                    {% else %}
                    <li class="breadcrumb-item active">Nuevo Servicio</li>
                    {% endif %}
                </ol>
            </nav>
            <h2>
                <i class="fas fa-server me-2"></i>
                {% if action == 'create' %}Nuevo Servicio{% else %}Editar Servicio{% endif %}
            </h2>
        </div>
    </div>

    <!-- Form -->
    <form method="POST" action="{% if action == 'create' %}{{ url_for('services.create') }}{% else %}{{ url_for('services.edit', service_id=service.id) }}{% endif %}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="row">
            <!-- Left Column: Main Information -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Información Básica</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="service_code" class="form-label">
                                    Código del Servicio
                                    {% if action == 'create' %}
                                    <i class="fas fa-question-circle text-muted"
                                       title="Se generará automáticamente según el tipo de servicio"
                                       data-bs-toggle="tooltip"></i>
                                    {% else %}
                                    <span class="text-danger">*</span>
                                    {% endif %}
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control {% if action == 'create' %}bg-light{% endif %}"
                                           id="service_code" name="service_code"
                                           value="{{ service.service_code if service else '' }}"
                                           placeholder="Se generará automáticamente"
                                           {% if action == 'create' %}readonly{% endif %}>
                                    {% if action == 'create' %}
                                    <button class="btn btn-outline-primary" type="button" id="manual_code_btn"
                                            title="Introducir código manualmente">
                                        <i class="fas fa-edit"></i> Manual
                                    </button>
                                    {% endif %}
                                </div>
                                <small class="text-muted" id="service_code_info">
                                    {% if action == 'create' %}
                                    <i class="fas fa-robot"></i> Se generará automáticamente al seleccionar el tipo
                                    {% else %}
                                    Código único del servicio
                                    {% endif %}
                                </small>
                            </div>
                            <div class="col-md-8">
                                <label for="name" class="form-label">Nombre del Servicio <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name"
                                       value="{{ service.name if service else '' }}"
                                       placeholder="Portal Web Corporativo" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Descripción</label>
                            <textarea class="form-control" id="description" name="description" rows="3"
                                      placeholder="Describe el propósito y alcance del servicio...">{{ service.description if service else '' }}</textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="service_type" class="form-label">Tipo de Servicio <span class="text-danger">*</span></label>
                                <select class="form-select" id="service_type" name="service_type" required>
                                    <option value="">Seleccione...</option>
                                    {% for type in service_types %}
                                    <option value="{{ type.name }}"
                                            {% if service and service.service_type == type %}selected{% endif %}>
                                        {{ type.value }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="status" class="form-label">Estado</label>
                                <select class="form-select" id="status" name="status">
                                    {% for status in service_statuses %}
                                    <option value="{{ status.name }}"
                                            {% if service and service.status == status %}selected{% elif not service and status.name == 'ACTIVE' %}selected{% endif %}>
                                        {{ status.value }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="department" class="form-label">Departamento</label>
                                <input type="text" class="form-control" id="department" name="department"
                                       value="{{ service.department if service else '' }}"
                                       placeholder="IT, Operaciones, etc."
                                       list="department-list">
                                <datalist id="department-list">
                                    <option value="IT">
                                    <option value="Operaciones">
                                    <option value="Finanzas">
                                    <option value="RRHH">
                                    <option value="Ventas">
                                    <option value="Marketing">
                                </datalist>
                            </div>
                            <div class="col-md-6">
                                <label for="operating_hours" class="form-label">Horario de Operación</label>
                                <input type="text" class="form-control" id="operating_hours" name="operating_hours"
                                       value="{{ service.operating_hours if service else '' }}"
                                       placeholder="24/7, 8-18 L-V, etc.">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="annual_cost" class="form-label">Costo Anual</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="annual_cost" name="annual_cost"
                                       value="{{ service.annual_cost if service else '' }}"
                                       step="0.01" min="0" placeholder="0.00">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Responsables</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="service_owner_id" class="form-label">Propietario del Servicio <span class="text-danger">*</span></label>
                                <select class="form-select" id="service_owner_id" name="service_owner_id" required>
                                    <option value="">Seleccione...</option>
                                    {% for user in users %}
                                    <option value="{{ user.id }}"
                                            {% if service and service.service_owner_id == user.id %}selected{% endif %}>
                                        {{ user.username }}{% if user.email %} ({{ user.email }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Responsable del servicio a nivel de negocio</small>
                            </div>
                            <div class="col-md-6">
                                <label for="technical_manager_id" class="form-label">Responsable Técnico</label>
                                <select class="form-select" id="technical_manager_id" name="technical_manager_id">
                                    <option value="">Sin asignar</option>
                                    {% for user in users %}
                                    <option value="{{ user.id }}"
                                            {% if service and service.technical_manager_id == user.id %}selected{% endif %}>
                                        {{ user.username }}{% if user.email %} ({{ user.email }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Responsable técnico del servicio</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assets Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-box me-2"></i>Activos que Soportan el Servicio</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            Selecciona los activos (hardware, software, información, etc.) que son necesarios para la operación de este servicio.
                        </p>

                        <!-- Buscador de activos -->
                        <div class="mb-3">
                            <label for="asset_search" class="form-label">Buscar Activos</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="asset_search"
                                       placeholder="Ej: HW-00001, switch, servidor...">
                            </div>
                            <small class="text-muted">Busca por código completo (HW-00001) o por nombre</small>
                        </div>

                        <!-- Lista de activos seleccionables -->
                        <div class="asset-selection-container" style="max-height: 400px; overflow-y: auto;">
                            {% for asset in assets %}
                            <div class="form-check asset-item" data-asset-name="{{ asset.asset_code|lower }} {{ asset.name|lower }}">
                                <input class="form-check-input" type="checkbox" name="asset_ids"
                                       value="{{ asset.id }}" id="asset_{{ asset.id }}"
                                       {% if service and asset in service.assets %}checked{% endif %}>
                                <label class="form-check-label w-100" for="asset_{{ asset.id }}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <code class="text-primary">{{ asset.asset_code }}</code> - {{ asset.name }}
                                            <br>
                                            <small class="text-muted">
                                                {% if asset.asset_type %}
                                                <i class="fas {{ asset.asset_type.icon }} me-1"></i>
                                                {{ asset.asset_type.name }}
                                                {% else %}
                                                <i class="fas fa-question-circle me-1"></i>
                                                <span class="text-warning">Sin tipo asignado</span>
                                                {% endif %}
                                                {% if asset.criticality and asset.criticality >= 8 %}
                                                <span class="badge bg-danger ms-2">Crítico</span>
                                                {% endif %}
                                            </small>
                                        </div>
                                        {% if asset.criticality %}
                                        <span class="badge bg-secondary">{{ asset.criticality }}/10</span>
                                        {% endif %}
                                    </div>
                                </label>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="mt-3">
                            <small class="text-muted">
                                <strong id="selected-count">
                                    {% if service %}{{ service.assets|length }}{% else %}0{% endif %}
                                </strong> activo(s) seleccionado(s)
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Dependencies Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-project-diagram me-2"></i>Dependencias de Servicios</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            Selecciona los servicios de los cuales <strong>depende</strong> este servicio para funcionar correctamente.
                        </p>

                        <!-- Buscador de servicios -->
                        <div class="mb-3">
                            <label for="service_search" class="form-label">Buscar Servicios</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="service_search"
                                       placeholder="Ej: SRV-001, Portal Web...">
                            </div>
                            <small class="text-muted">Busca por código o nombre de servicio</small>
                        </div>

                        <!-- Lista de servicios dependencias -->
                        <div class="service-selection-container" style="max-height: 300px; overflow-y: auto;">
                            {% for svc in services %}
                            {% if not service or svc.id != service.id %}
                            <div class="form-check service-item mb-2" data-service-name="{{ svc.service_code|lower }} {{ svc.name|lower }}">
                                <div class="d-flex align-items-start">
                                    <input class="form-check-input mt-1" type="checkbox" name="dependency_service_ids"
                                           value="{{ svc.id }}" id="dep_service_{{ svc.id }}"
                                           {% if service %}
                                               {% for dep in service.dependencies %}
                                                   {% if dep.depends_on_service_id == svc.id %}checked{% endif %}
                                               {% endfor %}
                                           {% endif %}>
                                    <div class="flex-grow-1 ms-2">
                                        <label class="form-check-label" for="dep_service_{{ svc.id }}">
                                            <code class="text-primary">{{ svc.service_code }}</code> - {{ svc.name }}
                                            <br>
                                            <small class="text-muted">
                                                <i class="fas fa-tag me-1"></i>{{ svc.service_type.value }}
                                                {% if svc.criticality >= 8 %}
                                                <span class="badge bg-danger ms-2">Crítico</span>
                                                {% endif %}
                                            </small>
                                        </label>
                                        <!-- Tipo de dependencia -->
                                        <div class="mt-2 dependency-type-container" style="display: none;" id="dep_type_container_{{ svc.id }}">
                                            <label class="form-label small mb-1">Tipo de dependencia:</label>
                                            <select class="form-select form-select-sm" name="dependency_types_{{ svc.id }}" id="dep_type_{{ svc.id }}">
                                                {% set dep_type = '' %}
                                                {% if service %}
                                                    {% for dep in service.dependencies %}
                                                        {% if dep.depends_on_service_id == svc.id %}
                                                            {% set dep_type = dep.dependency_type %}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                                <option value="required" {% if dep_type == 'required' %}selected{% endif %}>Requerida - Sin este servicio, no funciona</option>
                                                <option value="optional" {% if dep_type == 'optional' %}selected{% endif %}>Opcional - Funcionalidad reducida sin este</option>
                                                <option value="enhances" {% if dep_type == 'enhances' %}selected{% endif %}>Mejora - Añade funcionalidades extras</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>

                        <div class="mt-3">
                            <small class="text-muted">
                                <strong id="selected-dependencies-count">
                                    {% if service %}{{ service.dependencies|length }}{% else %}0{% endif %}
                                </strong> dependencia(s) seleccionada(s)
                            </small>
                        </div>

                        <div class="alert alert-info mt-3 mb-0" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>
                                <strong>Nota:</strong> Las dependencias ayudan a identificar el impacto cuando un servicio falla.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Metrics -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Métricas y SLA</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="criticality" class="form-label">
                                Criticidad
                                <span class="badge bg-secondary" id="criticality-badge">{{ service.criticality if service else 5 }}</span>
                            </label>
                            <input type="range" class="form-range" id="criticality" name="criticality"
                                   min="1" max="10" step="1"
                                   value="{{ service.criticality if service else 5 }}"
                                   oninput="updateCriticalityBadge(this.value)">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Baja (1)</small>
                                <small class="text-muted">Crítica (10)</small>
                            </div>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label for="required_availability" class="form-label">Disponibilidad Requerida (%)</label>
                            <input type="number" class="form-control" id="required_availability" name="required_availability"
                                   value="{{ service.required_availability if service else '' }}"
                                   step="0.01" min="0" max="100" placeholder="99.9">
                            <small class="text-muted">Ejemplo: 99.9 = 99.9% uptime</small>
                        </div>

                        <div class="mb-3">
                            <label for="rto" class="form-label">RTO - Recovery Time Objective (días)</label>
                            <input type="number" class="form-control" id="rto" name="rto"
                                   value="{{ service.rto if service else '' }}"
                                   step="0.01" min="0" placeholder="0.5">
                            <small class="text-muted">Tiempo máximo de recuperación (ej: 0.5 = 12 horas, 1 = 1 día)</small>
                        </div>

                        <div class="mb-3">
                            <label for="rpo" class="form-label">RPO - Recovery Point Objective (días)</label>
                            <input type="number" class="form-control" id="rpo" name="rpo"
                                   value="{{ service.rpo if service else '' }}"
                                   step="0.01" min="0" placeholder="0.25">
                            <small class="text-muted">Pérdida máxima de datos aceptable (ej: 0.25 = 6 horas, 0.5 = 12 horas)</small>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Ayuda</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>Tipos de Servicio:</strong></p>
                        <ul class="small">
                            <li><strong>Negocio:</strong> Servicios orientados al cliente</li>
                            <li><strong>Técnico:</strong> Servicios de soporte técnico</li>
                            <li><strong>Infraestructura:</strong> Red, servidores, etc.</li>
                            <li><strong>Aplicación:</strong> Software y aplicaciones</li>
                            <li><strong>Soporte:</strong> Servicios de respaldo</li>
                        </ul>
                        <hr>
                        <p class="mb-2"><strong>Criticidad:</strong></p>
                        <ul class="small mb-0">
                            <li>1-3: Baja (puede fallar sin gran impacto)</li>
                            <li>4-6: Media (impacto moderado)</li>
                            <li>7-8: Alta (impacto significativo)</li>
                            <li>9-10: Crítica (impacto severo en el negocio)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mt-4 mb-4">
            <div class="col-md-12">
                <div class="d-flex justify-content-between">
                    <a href="{% if service %}{{ url_for('services.detail', service_id=service.id) }}{% else %}{{ url_for('services.index') }}{% endif %}"
                       class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        {% if action == 'create' %}Crear Servicio{% else %}Guardar Cambios{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    // Variables para gestión de código de servicio
    let isManualCode = false;

    // Generar código de servicio automáticamente
    function generateServiceCode() {
        if (isManualCode) return; // No generar si es manual

        const serviceType = document.getElementById('service_type').value;

        if (!serviceType) {
            document.getElementById('service_code').value = '';
            document.getElementById('service_code_info').innerHTML =
                '<i class="fas fa-robot"></i> Selecciona un tipo de servicio para generar el código';
            return;
        }

        // Llamar a la API para generar el código
        fetch(`/servicios/api/generate-code?type=${serviceType}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al generar código');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    document.getElementById('service_code_info').innerHTML =
                        `<i class="fas fa-exclamation-triangle text-danger"></i> Error: ${data.error}`;
                    return;
                }

                // Actualizar el campo de código
                document.getElementById('service_code').value = data.service_code;
                document.getElementById('service_code_info').innerHTML =
                    `<i class="fas fa-robot text-success"></i> Código generado automáticamente: <strong>${data.service_code}</strong>`;
            })
            .catch(error => {
                console.error('Error al generar código:', error);
                document.getElementById('service_code_info').innerHTML =
                    '<i class="fas fa-exclamation-triangle text-danger"></i> Error al generar código';
            });
    }

    // Alternar entre modo automático y manual
    {% if action == 'create' %}
    document.getElementById('manual_code_btn').addEventListener('click', function() {
        isManualCode = !isManualCode;

        const codeField = document.getElementById('service_code');
        const btn = this;

        if (isManualCode) {
            // Modo manual
            codeField.readOnly = false;
            codeField.classList.remove('bg-light');
            codeField.placeholder = 'Ej: SRV-001';
            codeField.focus();
            btn.innerHTML = '<i class="fas fa-robot"></i> Auto';
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-success');
            document.getElementById('service_code_info').innerHTML =
                '<i class="fas fa-user-edit text-primary"></i> Código manual - puedes editarlo';
        } else {
            // Modo automático
            codeField.readOnly = true;
            codeField.classList.add('bg-light');
            codeField.placeholder = 'Se generará automáticamente';
            btn.innerHTML = '<i class="fas fa-edit"></i> Manual';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
            generateServiceCode();
        }
    });

    // Generar código cuando cambia el tipo de servicio
    document.getElementById('service_type').addEventListener('change', function() {
        generateServiceCode();
    });

    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    {% endif %}

    // Update criticality badge in real-time
    function updateCriticalityBadge(value) {
        const badge = document.getElementById('criticality-badge');
        badge.textContent = value;

        // Update badge color based on value
        badge.className = 'badge';
        if (value >= 9) {
            badge.classList.add('bg-danger');
        } else if (value >= 7) {
            badge.classList.add('bg-warning', 'text-dark');
        } else if (value >= 4) {
            badge.classList.add('bg-info');
        } else {
            badge.classList.add('bg-secondary');
        }
    }

    // Update selected assets count
    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('input[name="asset_ids"]:checked');
        const countElement = document.getElementById('selected-count');
        if (countElement) {
            countElement.textContent = checkboxes.length;
        }
    }

    // Filter assets by search term
    function filterAssetsBySearch(searchTerm) {
        const assetItems = document.querySelectorAll('.asset-item');
        const lowerSearchTerm = searchTerm.toLowerCase();

        assetItems.forEach(item => {
            const assetName = item.getAttribute('data-asset-name');
            if (assetName.includes(lowerSearchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // Filter services by search term
    function filterServicesBySearch(searchTerm) {
        const serviceItems = document.querySelectorAll('.service-item');
        const lowerSearchTerm = searchTerm.toLowerCase();

        serviceItems.forEach(item => {
            const serviceName = item.getAttribute('data-service-name');
            if (serviceName.includes(lowerSearchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // Update selected dependencies count
    function updateSelectedDependenciesCount() {
        const checkboxes = document.querySelectorAll('input[name="dependency_service_ids"]:checked');
        const countElement = document.getElementById('selected-dependencies-count');
        if (countElement) {
            countElement.textContent = checkboxes.length;
        }
    }

    // Toggle dependency type selector visibility
    function toggleDependencyTypeSelector(checkbox) {
        const serviceId = checkbox.value;
        const typeContainer = document.getElementById('dep_type_container_' + serviceId);
        if (typeContainer) {
            if (checkbox.checked) {
                typeContainer.style.display = 'block';
            } else {
                typeContainer.style.display = 'none';
            }
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize criticality badge
        const criticalityInput = document.getElementById('criticality');
        if (criticalityInput) {
            updateCriticalityBadge(criticalityInput.value);
        }

        // Asset search functionality
        const assetSearch = document.getElementById('asset_search');
        if (assetSearch) {
            assetSearch.addEventListener('input', function(e) {
                filterAssetsBySearch(e.target.value);
            });
        }

        // Asset checkbox change event
        const assetCheckboxes = document.querySelectorAll('input[name="asset_ids"]');
        assetCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });

        // Service search functionality
        const serviceSearch = document.getElementById('service_search');
        if (serviceSearch) {
            serviceSearch.addEventListener('input', function(e) {
                filterServicesBySearch(e.target.value);
            });
        }

        // Dependency checkbox change event
        const dependencyCheckboxes = document.querySelectorAll('input[name="dependency_service_ids"]');
        dependencyCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectedDependenciesCount();
                toggleDependencyTypeSelector(this);
            });
            // Initialize visibility of type selectors for checked items
            if (checkbox.checked) {
                toggleDependencyTypeSelector(checkbox);
            }
        });

        // Initialize selected counts
        updateSelectedCount();
        updateSelectedDependenciesCount();
    });
</script>
{% endblock %}

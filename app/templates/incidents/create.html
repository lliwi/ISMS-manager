{% extends "base.html" %}

{% block title %}Reportar Incidente - ISMS Manager{% endblock %}

{% block extra_head %}
<style>
    .required:after {
        content: " *";
        color: red;
    }
    .form-section {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }
    .form-section h5 {
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <!-- Header -->
            <div class="mb-4">
                <h2><i class="fas fa-bug me-2"></i>Reportar Incidente de Seguridad</h2>
                <p class="text-muted">
                    Control 6.8 - Notificación de eventos de seguridad de la información<br>
                    Complete el formulario para reportar un incidente o evento de seguridad
                </p>
            </div>

            <form method="POST" action="{{ url_for('incidents.create') }}" id="incidentForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <!-- Información Básica -->
                <div class="form-section">
                    <h5><i class="fas fa-info-circle me-2"></i>Información Básica</h5>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label required">Título del Incidente</label>
                            <input type="text" name="title" class="form-control"
                                   placeholder="Resumen breve del incidente"
                                   required maxlength="200">
                            <small class="text-muted">Describa el incidente en una frase concisa</small>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label required">Descripción Detallada</label>
                            <textarea name="description" class="form-control" rows="4"
                                      placeholder="Describa el incidente con el mayor detalle posible"
                                      required></textarea>
                            <small class="text-muted">
                                Incluya: qué ocurrió, cuándo se detectó, cómo se descubrió, alcance estimado
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Clasificación -->
                <div class="form-section">
                    <h5><i class="fas fa-tags me-2"></i>Clasificación del Incidente</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">Categoría</label>
                            <select name="category" class="form-select" required>
                                <option value="">Seleccione...</option>
                                {% for cat in IncidentCategory %}
                                <option value="{{ cat.name }}">{{ cat.value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">Severidad</label>
                            <select name="severity" class="form-select" required>
                                <option value="">Seleccione...</option>
                                {% for sev in IncidentSeverity %}
                                <option value="{{ sev.name }}">{{ sev.value }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                <strong>Crítica:</strong> Impacto severo inmediato<br>
                                <strong>Alta:</strong> Impacto significativo<br>
                                <strong>Media:</strong> Impacto moderado<br>
                                <strong>Baja:</strong> Impacto menor
                            </small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">Prioridad</label>
                            <select name="priority" class="form-select" required>
                                <option value="">Seleccione...</option>
                                {% for pri in IncidentPriority %}
                                <option value="{{ pri.name }}">{{ pri.value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Asignar a</label>
                            <select name="assigned_to_id" class="form-select">
                                <option value="">Sin asignar</option>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Detección y Origen -->
                <div class="form-section">
                    <h5><i class="fas fa-search me-2"></i>Detección y Origen</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">Fecha de Descubrimiento</label>
                            <input type="datetime-local" name="discovery_date"
                                   class="form-control" required
                                   max="{{ now.strftime('%Y-%m-%dT%H:%M') }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">Método de Detección</label>
                            <select name="detection_method" class="form-select" required>
                                <option value="">Seleccione...</option>
                                {% for method in DetectionMethod %}
                                <option value="{{ method.name }}">{{ method.value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Origen del Incidente</label>
                            <select name="source" class="form-select">
                                {% for source in IncidentSource %}
                                <option value="{{ source.name }}">{{ source.value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Detalles de la Detección</label>
                            <textarea name="detection_details" class="form-control" rows="3"
                                      placeholder="¿Cómo se detectó el incidente? ¿Qué indicadores o alertas se observaron?"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Impacto CIA -->
                <div class="form-section">
                    <h5><i class="fas fa-shield-alt me-2"></i>Impacto en Confidencialidad, Integridad y Disponibilidad (CIA)</h5>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Marque los aspectos de seguridad afectados por este incidente
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox"
                                       id="impact_confidentiality" name="impact_confidentiality">
                                <label class="form-check-label" for="impact_confidentiality">
                                    <strong>Confidencialidad</strong><br>
                                    <small class="text-muted">
                                        Información expuesta o accedida sin autorización
                                    </small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox"
                                       id="impact_integrity" name="impact_integrity">
                                <label class="form-check-label" for="impact_integrity">
                                    <strong>Integridad</strong><br>
                                    <small class="text-muted">
                                        Información modificada, alterada o corrompida
                                    </small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox"
                                       id="impact_availability" name="impact_availability">
                                <label class="form-check-label" for="impact_availability">
                                    <strong>Disponibilidad</strong><br>
                                    <small class="text-muted">
                                        Servicios o información no disponible
                                    </small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activos Afectados -->
                <div class="form-section">
                    <h5><i class="fas fa-box me-2"></i>Activos Afectados (Opcional)</h5>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Seleccione los activos afectados</label>
                            <select name="affected_assets[]" class="form-select" multiple size="5">
                                {% for asset in assets %}
                                <option value="{{ asset.id }}">
                                    {{ asset.name }} ({{ asset.category.value if asset.category else 'Sin categoría' }})
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                Mantenga presionada la tecla Ctrl/Cmd para seleccionar múltiples activos
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('incidents.index') }}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Reportar Incidente
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Establecer fecha/hora actual por defecto
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.querySelector('input[name="discovery_date"]').value = now.toISOString().slice(0,16);

    // Validación del formulario
    document.getElementById('incidentForm').addEventListener('submit', function(e) {
        const title = document.querySelector('input[name="title"]').value;
        const description = document.querySelector('textarea[name="description"]').value;

        if (title.length < 10) {
            e.preventDefault();
            alert('El título debe tener al menos 10 caracteres');
            return false;
        }

        if (description.length < 20) {
            e.preventDefault();
            alert('La descripción debe tener al menos 20 caracteres');
            return false;
        }
    });

    // Ayuda contextual para categorías
    const categorySelect = document.querySelector('select[name="category"]');
    categorySelect.addEventListener('change', function() {
        const severity = document.querySelector('select[name="severity"]');
        const priority = document.querySelector('select[name="priority"]');

        // Sugerencias según categoría
        if (['RANSOMWARE', 'DATA_BREACH', 'MALWARE'].includes(this.value)) {
            if (!severity.value) severity.value = 'HIGH';
            if (!priority.value) priority.value = 'URGENT';
        }
    });
});
</script>
{% endblock %}

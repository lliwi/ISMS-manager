{% extends "base.html" %}

{% block title %}Reportes de Incidentes - ISMS Manager{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='vendor/chartjs/chart.umd.min.js') }}"></script>
<style>
    .metric-card {
        border-radius: 10px;
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: scale(1.05);
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
    .kpi-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
    }
    .trend-up {
        color: #28a745;
    }
    .trend-down {
        color: #dc3545;
    }
    .filter-section {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2><i class="fas fa-chart-line me-2"></i>Reportes y Métricas de Incidentes</h2>
            <p class="text-muted">Análisis y estadísticas de gestión de incidentes de seguridad</p>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-primary" onclick="exportReport('pdf')">
                <i class="fas fa-file-pdf me-2"></i>Exportar PDF
            </button>
            <button class="btn btn-success" onclick="exportReport('excel')">
                <i class="fas fa-file-excel me-2"></i>Exportar Excel
            </button>
        </div>
    </div>

    <!-- Filtros de Periodo -->
    <div class="filter-section">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Periodo</label>
                <select name="period" class="form-select" onchange="this.form.submit()">
                    <option value="7" {% if period == 7 %}selected{% endif %}>Últimos 7 días</option>
                    <option value="30" {% if period == 30 %}selected{% endif %}>Últimos 30 días</option>
                    <option value="90" {% if period == 90 %}selected{% endif %}>Últimos 3 meses</option>
                    <option value="180" {% if period == 180 %}selected{% endif %}>Últimos 6 meses</option>
                    <option value="365" {% if period == 365 %}selected{% endif %}>Último año</option>
                    <option value="custom" {% if period == 'custom' %}selected{% endif %}>Personalizado</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Desde</label>
                <input type="date" name="start_date" class="form-control"
                       value="{{ start_date }}" onchange="this.form.submit()">
            </div>
            <div class="col-md-3">
                <label class="form-label">Hasta</label>
                <input type="date" name="end_date" class="form-control"
                       value="{{ end_date }}" onchange="this.form.submit()">
            </div>
            <div class="col-md-3">
                <label class="form-label">Categoría</label>
                <select name="category" class="form-select" onchange="this.form.submit()">
                    <option value="all">Todas</option>
                    {% for cat in IncidentCategory %}
                    <option value="{{ cat.name }}" {% if category == cat.name %}selected{% endif %}>
                        {{ cat.value }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>

    <!-- KPIs Principales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card metric-card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Total Incidentes</h6>
                            <h2 class="card-title mb-0">{{ metrics.total }}</h2>
                            <small class="opacity-75">
                                {% if metrics.trend_total > 0 %}
                                <i class="fas fa-arrow-up trend-up"></i> +{{ metrics.trend_total }}%
                                {% elif metrics.trend_total < 0 %}
                                <i class="fas fa-arrow-down trend-down"></i> {{ metrics.trend_total }}%
                                {% else %}
                                <i class="fas fa-minus"></i> Sin cambios
                                {% endif %}
                                vs periodo anterior
                            </small>
                        </div>
                        <i class="fas fa-bug fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Incidentes Críticos</h6>
                            <h2 class="card-title mb-0">{{ metrics.critical }}</h2>
                            <small class="opacity-75">
                                {{ (metrics.critical / metrics.total * 100)|round(1) if metrics.total > 0 else 0 }}% del total
                            </small>
                        </div>
                        <i class="fas fa-exclamation-triangle fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Tasa Resolución</h6>
                            <h2 class="card-title mb-0">{{ metrics.resolution_rate|round(1) }}%</h2>
                            <small class="opacity-75">
                                {{ metrics.resolved }} de {{ metrics.total }} resueltos
                            </small>
                        </div>
                        <i class="fas fa-check-circle fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Tiempo Medio Resolución</h6>
                            <h2 class="card-title mb-0">{{ metrics.avg_resolution_time|round(1) }}</h2>
                            <small class="opacity-75">horas</small>
                        </div>
                        <i class="fas fa-clock fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row mb-4">
        <!-- Tendencia Temporal -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Tendencia de Incidentes</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Distribución por Severidad -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Distribución por Severidad</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="severityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Distribución por Categoría -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Incidentes por Categoría</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estados de Incidentes -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-doughnut me-2"></i>Estado de Incidentes</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas Detalladas -->
    <div class="row mb-4">
        <!-- Tiempos de Respuesta -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-stopwatch me-2"></i>Tiempos de Respuesta y Resolución</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Métrica</th>
                                <th class="text-end">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Tiempo Medio de Primera Respuesta</td>
                                <td class="text-end"><strong>{{ metrics.avg_response_time|round(1) }}</strong> horas</td>
                            </tr>
                            <tr>
                                <td>Tiempo Medio de Contención</td>
                                <td class="text-end"><strong>{{ metrics.avg_containment_time|round(1) }}</strong> horas</td>
                            </tr>
                            <tr>
                                <td>Tiempo Medio de Resolución</td>
                                <td class="text-end"><strong>{{ metrics.avg_resolution_time|round(1) }}</strong> horas</td>
                            </tr>
                            <tr>
                                <td>Tiempo Medio hasta Cierre</td>
                                <td class="text-end"><strong>{{ metrics.avg_closure_time|round(1) }}</strong> horas</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Impacto CIA -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Impacto en Triada CIA</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="ciaChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Confidencialidad, Integridad y Disponibilidad afectadas
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Incidentes y Análisis -->
    <div class="row mb-4">
        <!-- Top 10 Incidentes por Impacto -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Top 10 Incidentes Más Críticos</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Incidente</th>
                                    <th>Severidad</th>
                                    <th>Estado</th>
                                    <th>Días Abierto</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for incident in top_incidents[:10] %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('incidents.view', id=incident.id) }}">
                                            {{ incident.incident_number }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge
                                            {% if incident.severity.name == 'CRITICAL' %}bg-danger
                                            {% elif incident.severity.name == 'HIGH' %}bg-warning text-dark
                                            {% elif incident.severity.name == 'MEDIUM' %}bg-info
                                            {% else %}bg-success{% endif %}">
                                            {{ incident.severity.value }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ incident.status.value }}</span>
                                    </td>
                                    <td>{{ incident.days_open }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Brechas de Datos RGPD -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i>Brechas de Datos (RGPD)</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-md-4">
                            <h3 class="text-danger">{{ metrics.data_breaches }}</h3>
                            <small class="text-muted">Total de Brechas</small>
                        </div>
                        <div class="col-md-4">
                            <h3 class="text-warning">{{ metrics.data_breaches_pending }}</h3>
                            <small class="text-muted">Pendientes Notificar</small>
                        </div>
                        <div class="col-md-4">
                            <h3 class="text-success">{{ metrics.data_breaches_notified }}</h3>
                            <small class="text-muted">Notificadas</small>
                        </div>
                    </div>
                    {% if metrics.data_breaches_72h_violation > 0 %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>{{ metrics.data_breaches_72h_violation }}</strong> brechas no notificadas
                        en el plazo de 72 horas requerido por RGPD
                    </div>
                    {% endif %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Incidente</th>
                                    <th>Descubierto</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for breach in data_breaches[:5] %}
                                <tr class="{% if breach.is_72h_violation %}table-danger{% endif %}">
                                    <td>
                                        <a href="{{ url_for('incidents.view', id=breach.id) }}">
                                            {{ breach.incident_number }}
                                        </a>
                                    </td>
                                    <td>{{ breach.discovery_date.strftime('%d/%m/%Y') }}</td>
                                    <td>
                                        {% if breach.notification_date %}
                                        <span class="badge bg-success">Notificada</span>
                                        {% else %}
                                        <span class="badge bg-warning">Pendiente</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cumplimiento ISO 27001 -->
    <div class="row">
        <div class="col-md-12">
            <div class="kpi-card">
                <h4 class="mb-3"><i class="fas fa-certificate me-2"></i>Indicadores de Cumplimiento ISO/IEC 27001:2023</h4>
                <div class="row">
                    <div class="col-md-3">
                        <h6 class="opacity-75">Control 5.24 - Planificación</h6>
                        <h3>{{ metrics.compliance_5_24|round(1) }}%</h3>
                        <small>Incidentes con plan documentado</small>
                    </div>
                    <div class="col-md-3">
                        <h6 class="opacity-75">Control 5.25 - Evaluación</h6>
                        <h3>{{ metrics.compliance_5_25|round(1) }}%</h3>
                        <small>Incidentes evaluados correctamente</small>
                    </div>
                    <div class="col-md-3">
                        <h6 class="opacity-75">Control 5.27 - Lecciones</h6>
                        <h3>{{ metrics.compliance_5_27|round(1) }}%</h3>
                        <small>Incidentes con lecciones aprendidas</small>
                    </div>
                    <div class="col-md-3">
                        <h6 class="opacity-75">Control 5.28 - Evidencias</h6>
                        <h3>{{ metrics.compliance_5_28|round(1) }}%</h3>
                        <small>Incidentes con evidencias recolectadas</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Datos para gráficos
const chartData = {{ chart_data|tojson }};

// Gráfico de Tendencia
const trendCtx = document.getElementById('trendChart').getContext('2d');
new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: chartData.trend.labels,
        datasets: [{
            label: 'Incidentes',
            data: chartData.trend.data,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        }
    }
});

// Gráfico de Severidad
const severityCtx = document.getElementById('severityChart').getContext('2d');
new Chart(severityCtx, {
    type: 'pie',
    data: {
        labels: chartData.severity.labels,
        datasets: [{
            data: chartData.severity.data,
            backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#28a745']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

// Gráfico de Categoría
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
new Chart(categoryCtx, {
    type: 'bar',
    data: {
        labels: chartData.category.labels,
        datasets: [{
            label: 'Incidentes',
            data: chartData.category.data,
            backgroundColor: '#667eea'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});

// Gráfico de Estado
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: chartData.status.labels,
        datasets: [{
            data: chartData.status.data,
            backgroundColor: ['#ffc107', '#0dcaf0', '#0d6efd', '#28a745', '#6c757d']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

// Gráfico CIA
const ciaCtx = document.getElementById('ciaChart').getContext('2d');
new Chart(ciaCtx, {
    type: 'radar',
    data: {
        labels: ['Confidencialidad', 'Integridad', 'Disponibilidad'],
        datasets: [{
            label: 'Incidentes Afectados',
            data: chartData.cia.data,
            backgroundColor: 'rgba(102, 126, 234, 0.2)',
            borderColor: '#667eea',
            pointBackgroundColor: '#667eea'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            r: { beginAtZero: true }
        }
    }
});

// Exportar reportes
function exportReport(format) {
    const params = new URLSearchParams(window.location.search);
    params.set('format', format);
    window.location.href = `/incidents/reports/export?${params.toString()}`;
}
</script>
{% endblock %}

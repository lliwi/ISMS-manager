{% extends "base.html" %}

{% block title %}Dashboard - ISMS Manager{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h2 mb-0">Dashboard</h1>
        <p class="text-muted">Bienvenido, {{ current_user.first_name or current_user.username }}</p>
    </div>
</div>

<!-- KPI Cards -->
<div class="row mb-4">
    <!-- 1. SOA -->
    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title small">Cumplimiento SOA</h6>
                        <h3 class="mb-0">{{ "%.1f"|format(kpis.soa_compliance) }}%</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clipboard-check fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Documentos -->
    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
        <a href="{{ url_for('documents.index') }}" class="text-decoration-none">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title small">Documentos</h6>
                            <h3 class="mb-0">{{ kpis.approved_documents }}</h3>
                            <small class="d-block">{{ kpis.pending_review_documents }} en revisión</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-alt fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <!-- 3. Riesgos -->
    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
        <div class="card bg-warning text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title small">Riesgos Altos</h6>
                        <h3 class="mb-0">{{ kpis.high_risk_count }}</h3>
                        <small class="d-block">de {{ kpis.total_risks }} total</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Incidentes -->
    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
        <div class="card bg-danger text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title small">Incidentes</h6>
                        <h3 class="mb-0">{{ kpis.open_incidents }}</h3>
                        <small class="d-block">{{ kpis.incidents_this_month }} este mes</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-bug fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. No Conformidades -->
    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
        <a href="{{ url_for('nonconformities.index') }}" class="text-decoration-none">
            <div class="card bg-dark text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title small">No Conformidades</h6>
                            <h3 class="mb-0">{{ kpis.open_nonconformities }}</h3>
                            <small class="d-block">{{ kpis.overdue_nonconformities }} vencidas</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-circle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <!-- 6. Cambios -->
    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
        <a href="{{ url_for('changes.index') }}" class="text-decoration-none">
            <div class="card bg-secondary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title small">Cambios</h6>
                            <h3 class="mb-0">{{ kpis.pending_changes }}</h3>
                            <small class="d-block">{{ kpis.approved_changes_month }} aprobados mes</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exchange-alt fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <!-- 7. Tareas -->
    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title small">Mis Tareas</h6>
                        <h3 class="mb-0">{{ kpis.my_pending_tasks }}</h3>
                        <small class="d-block">{{ kpis.overdue_tasks }} vencidas</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tasks fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== NUEVAS SECCIONES - MÉTRICAS ADICIONALES ========== -->

<!-- Sección: Alertas Críticas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Alertas Críticas</h5>
                <span class="badge bg-white text-danger" id="alertsCount">0</span>
            </div>
            <div class="card-body p-0">
                <div id="criticalAlerts" class="list-group list-group-flush">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sección: Métricas Operativas -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <h6 class="text-muted">Tasa Completitud Tareas</h6>
                <h3 id="taskCompletionRate">--</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-clipboard-check fa-2x text-info mb-2"></i>
                <h6 class="text-muted">Efectividad NC</h6>
                <h3 id="ncEffectivenessRate">--</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                <h6 class="text-muted">Tiempo Resp. Incidentes</h6>
                <h3 id="avgIncidentResponse">--</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-exchange-alt fa-2x text-primary mb-2"></i>
                <h6 class="text-muted">Éxito de Cambios</h6>
                <h3 id="changeSuccessRate">--</h3>
            </div>
        </div>
    </div>
</div>

<!-- Sección: Gráficos de Tendencias -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Tendencia de Incidentes (6 meses)</h6>
            </div>
            <div class="card-body">
                <canvas id="incidentsTrendChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Distribución de Riesgos</h6>
            </div>
            <div class="card-body">
                <canvas id="riskDistributionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Sección: Mapa de Calor de Riesgos -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-th me-2"></i>Mapa de Calor de Riesgos (Impacto vs Probabilidad)</h6>
            </div>
            <div class="card-body">
                <div id="riskHeatmap"></div>
            </div>
        </div>
    </div>
</div>

<!-- Sección: Métricas de Auditoría y Distribuciones -->
<div class="row mb-4">
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Métricas de Auditoría</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Tasa Completitud</span>
                        <strong id="auditCompletionRate">--</strong>
                    </div>
                    <div class="progress mt-1" style="height: 10px;">
                        <div id="auditCompletionBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Cobertura ISO 27001</span>
                        <strong id="isoCoverage">--</strong>
                    </div>
                    <div class="progress mt-1" style="height: 10px;">
                        <div id="isoCoverageBar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span>Hallazgos Abiertos</span>
                    <span class="badge bg-warning" id="openFindings">0</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Acciones Vencidas</span>
                    <span class="badge bg-danger" id="overdueActions">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-server me-2"></i>Distribución de Activos</h6>
            </div>
            <div class="card-body">
                <canvas id="assetsDistributionChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Distribución de Servicios</h6>
            </div>
            <div class="card-body">
                <canvas id="servicesDistributionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Content Row -->
<div class="row">
    <!-- Recent Incidents -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Incidentes Recientes</h6>
                <a href="{{ url_for('incidents.index') }}" class="btn btn-sm btn-outline-primary">Ver todos</a>
            </div>
            <div class="card-body p-0">
                {% if recent_incidents %}
                    <div class="list-group list-group-flush">
                        {% for incident in recent_incidents %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ incident.title }}</h6>
                                <small class="badge bg-{{ 'danger' if incident.severity == 'critical' else 'warning' if incident.severity == 'high' else 'info' }}">
                                    {{ incident.severity }}
                                </small>
                            </div>
                            <p class="mb-1 text-truncate">{{ incident.description }}</p>
                            <small class="text-muted">{{ incident.discovery_date.strftime('%d/%m/%Y %H:%M') if incident.discovery_date else 'Sin fecha' }}</small>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-center text-muted py-3">No hay incidentes recientes</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recent Non-Conformities -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">No Conformidades Recientes</h6>
                <a href="{{ url_for('nonconformities.index') }}" class="btn btn-sm btn-outline-primary">Ver todas</a>
            </div>
            <div class="card-body p-0">
                {% if recent_nonconformities %}
                    <div class="list-group list-group-flush">
                        {% for nc in recent_nonconformities %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ nc.title }}</h6>
                                <small class="badge bg-{{ 'danger' if nc.severity == 'critical' else 'warning' if nc.severity == 'major' else 'secondary' }}">
                                    {{ nc.severity }}
                                </small>
                            </div>
                            <p class="mb-1 text-truncate">{{ nc.description }}</p>
                            <small class="text-muted">{{ nc.created_at.strftime('%d/%m/%Y') }}</small>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-center text-muted py-3">No hay no conformidades recientes</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- My Tasks -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Mis Tareas Pendientes</h6>
                <a href="{{ url_for('tasks.index') }}" class="btn btn-sm btn-outline-primary">Ver todas</a>
            </div>
            <div class="card-body p-0">
                {% if my_tasks %}
                    <div class="list-group list-group-flush">
                        {% for task in my_tasks %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ task.title }}</h6>
                                <small class="text-muted">{{ task.due_date.strftime('%d/%m') }}</small>
                            </div>
                            <p class="mb-1 text-truncate">{{ task.description or 'Sin descripción' }}</p>
                            <small class="badge bg-{{ 'danger' if task.due_date and task.due_date < current_datetime else 'primary' }}">
                                {{ task.task_type or 'General' }}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-center text-muted py-3">No tienes tareas pendientes</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- SOA Applicability Heatmap -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0"><i class="fas fa-th me-2"></i>Aplicabilidad de Controles SOA ISO 27001:2022</h6>
                    <small class="text-muted">Mapa de aplicabilidad por dominios y categorías</small>
                </div>
                <a href="{{ url_for('soa.index') }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-clipboard-list me-1"></i>Gestionar SOA
                </a>
            </div>
            <div class="card-body">
                <div id="soaApplicabilityMap" class="table-responsive">
                    <!-- El contenido se cargará dinámicamente -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>

                <!-- Leyenda -->
                <div class="mt-3">
                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted">
                                <strong>Leyenda:</strong>
                                <span class="badge ms-2" style="background-color: #0d6efd;">Aplicable</span>
                                <span class="badge ms-2" style="background-color: #6c757d;">No Aplicable</span>
                                <span class="badge ms-2" style="background-color: #ffc107; color: #000;">Transferido</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SOA Maturity Radar Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Madurez de Controles SOA</h6>
                    <small class="text-muted" id="chartSubtitle">Nivel de implementación promedio según ISO 27001</small>
                </div>
                <div class="d-flex gap-2">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active" id="btnShowCategories" onclick="toggleRadarChart('categories')">
                            <i class="fas fa-layer-group me-1"></i>Por Categorías
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="btnShowControls" onclick="toggleRadarChart('controls')">
                            <i class="fas fa-list me-1"></i>Por Controles
                        </button>
                    </div>
                    <a href="{{ url_for('soa.index') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-clipboard-list me-1"></i>Ver SOA
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Gráfico de Categorías -->
                <div id="categoryChartContainer" style="position: relative; height: 400px;">
                    <canvas id="soaRadarChart"></canvas>
                </div>

                <!-- Gráfico de Controles Individuales -->
                <div id="controlsChartContainer" style="position: relative; height: 450px; display: none;">
                    <canvas id="soaControlsRadarChart"></canvas>
                </div>

                <!-- Leyenda para gráfico de categorías -->
                <div id="categoryLegend" class="mt-3">
                    <div class="row text-center">
                        <div class="col-12">
                            <small class="text-muted">
                                <strong>Escala de Madurez:</strong>
                                <span class="badge bg-secondary mx-1">0 - No Implementado</span>
                                <span class="badge bg-danger mx-1">1 - Inicial</span>
                                <span class="badge bg-warning mx-1">2 - Repetible</span>
                                <span class="badge bg-info mx-1">3 - Definido</span>
                                <span class="badge bg-primary mx-1">4 - Controlado</span>
                                <span class="badge bg-success mx-1">5 - Cuantificado</span>
                                <span class="badge bg-dark mx-1">6 - Optimizado</span>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Estadísticas para gráfico de controles -->
                <div id="controlsLegend" class="mt-3" style="display: none;">
                    <div class="row">
                        <div class="col-md-3 text-center" id="domainA5">
                            <h6 class="text-primary mb-1">-</h6>
                            <small class="text-muted">Organizacional (A.5)</small>
                        </div>
                        <div class="col-md-3 text-center" id="domainA6">
                            <h6 class="text-warning mb-1">-</h6>
                            <small class="text-muted">Personas (A.6)</small>
                        </div>
                        <div class="col-md-3 text-center" id="domainA7">
                            <h6 class="text-info mb-1">-</h6>
                            <small class="text-muted">Físico (A.7)</small>
                        </div>
                        <div class="col-md-3 text-center" id="domainA8">
                            <h6 class="text-success mb-1">-</h6>
                            <small class="text-muted">Tecnológico (A.8)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/chart.umd.min.js') }}"></script>
<script>
// Cargar datos del gráfico de radar de SOA
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/soa-radar-data')
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al cargar datos del SOA');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                console.error('Error:', data.error);
                document.getElementById('soaRadarChart').parentElement.innerHTML =
                    `<div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>${data.error}
                    </div>`;
                return;
            }

            // Crear gráfico de radar
            const ctx = document.getElementById('soaRadarChart').getContext('2d');

            // Acortar nombres de categorías muy largas
            const labels = data.categories.map(cat => {
                if (cat.length > 30) {
                    return cat.substring(0, 27) + '...';
                }
                return cat;
            });

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nivel de Madurez Promedio',
                        data: data.maturity_scores,
                        fill: true,
                        backgroundColor: 'rgba(13, 110, 253, 0.2)',
                        borderColor: 'rgb(13, 110, 253)',
                        pointBackgroundColor: 'rgb(13, 110, 253)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(13, 110, 253)',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 11
                                }
                            },
                            suggestedMin: 0,
                            suggestedMax: data.max_maturity,
                            ticks: {
                                stepSize: 1,
                                callback: function(value, index, values) {
                                    const labels = ['No Impl.', 'Inicial', 'Repetible', 'Definido', 'Controlado', 'Cuantif.', 'Optimiz.'];
                                    return labels[value] || value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return data.categories[context[0].dataIndex];
                                },
                                label: function(context) {
                                    const score = context.parsed.r;
                                    const maturityLabels = {
                                        0: 'No Implementado',
                                        1: 'Inicial',
                                        2: 'Repetible',
                                        3: 'Definido',
                                        4: 'Controlado',
                                        5: 'Cuantificado',
                                        6: 'Optimizado'
                                    };

                                    const roundedScore = Math.round(score);
                                    const maturityLabel = maturityLabels[roundedScore] || 'Desconocido';
                                    const controlCount = data.control_counts[context.dataIndex];

                                    return [
                                        `Madurez: ${score.toFixed(2)}/6 (${maturityLabel})`,
                                        `Controles: ${controlCount}`
                                    ];
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `Madurez SOA - ${data.soa_version}`,
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error al cargar el gráfico:', error);
            document.getElementById('soaRadarChart').parentElement.innerHTML =
                `<div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-circle me-2"></i>Error al cargar el gráfico de madurez SOA
                </div>`;
        });
});

// Variables globales para los gráficos
let controlsChart = null;
let currentChartType = 'categories';

// Cargar datos del gráfico de controles individuales
function loadControlsRadarChart() {
    fetch('/api/soa-controls-radar-data')
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al cargar datos de controles');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                console.error('Error:', data.error);
                return;
            }

            // Actualizar estadísticas de dominios
            if (data.domains) {
                if (data.domains['A.5']) {
                    document.querySelector('#domainA5 h6').textContent = data.domains['A.5'].avg_maturity.toFixed(2);
                }
                if (data.domains['A.6']) {
                    document.querySelector('#domainA6 h6').textContent = data.domains['A.6'].avg_maturity.toFixed(2);
                }
                if (data.domains['A.7']) {
                    document.querySelector('#domainA7 h6').textContent = data.domains['A.7'].avg_maturity.toFixed(2);
                }
                if (data.domains['A.8']) {
                    document.querySelector('#domainA8 h6').textContent = data.domains['A.8'].avg_maturity.toFixed(2);
                }
            }

            // Crear gráfico de radar de controles
            const ctx = document.getElementById('soaControlsRadarChart').getContext('2d');

            controlsChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: data.control_labels,
                    datasets: [{
                        label: 'Nivel de Madurez por Control',
                        data: data.maturity_scores,
                        fill: true,
                        backgroundColor: 'rgba(220, 53, 69, 0.2)',
                        borderColor: 'rgb(220, 53, 69)',
                        pointBackgroundColor: 'rgb(220, 53, 69)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(220, 53, 69)',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 10
                                }
                            },
                            suggestedMin: 0,
                            suggestedMax: 6,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    const labels = ['No', 'Ini', 'Rep', 'Def', 'Ctrl', 'Cuant', 'Opt'];
                                    return labels[value] || value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return data.control_details[index].full_label;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const detail = data.control_details[index];
                                    const score = detail.maturity_score;

                                    const maturityLabels = {
                                        0: 'No Implementado',
                                        1: 'Inicial',
                                        2: 'Repetible',
                                        3: 'Definido',
                                        4: 'Controlado',
                                        5: 'Cuantificado',
                                        6: 'Optimizado'
                                    };

                                    return [
                                        `Madurez: ${score}/6 (${maturityLabels[score] || 'Desconocido'})`,
                                        `Dominio: ${detail.domain}`,
                                        `Categoría: ${detail.category}`
                                    ];
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `Controles Individuales - ${data.soa_version} (${data.total_controls_shown} de ${data.total_controls})`,
                            font: {
                                size: 13,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });

        })
        .catch(error => {
            console.error('Error al cargar el gráfico de controles:', error);
        });
}

// Función para alternar entre gráficos
function toggleRadarChart(type) {
    const categoryChartContainer = document.getElementById('categoryChartContainer');
    const controlsChartContainer = document.getElementById('controlsChartContainer');
    const categoryLegend = document.getElementById('categoryLegend');
    const controlsLegend = document.getElementById('controlsLegend');
    const btnCategories = document.getElementById('btnShowCategories');
    const btnControls = document.getElementById('btnShowControls');
    const chartSubtitle = document.getElementById('chartSubtitle');

    if (type === 'categories') {
        categoryChartContainer.style.display = 'block';
        controlsChartContainer.style.display = 'none';
        categoryLegend.style.display = 'block';
        controlsLegend.style.display = 'none';
        btnCategories.classList.add('active');
        btnControls.classList.remove('active');
        chartSubtitle.textContent = 'Nivel de implementación promedio según ISO 27001';
        currentChartType = 'categories';
    } else {
        categoryChartContainer.style.display = 'none';
        controlsChartContainer.style.display = 'block';
        categoryLegend.style.display = 'none';
        controlsLegend.style.display = 'block';
        btnCategories.classList.remove('active');
        btnControls.classList.add('active');
        chartSubtitle.textContent = 'Top 5 controles por dominio ISO 27001 ordenados por madurez';
        currentChartType = 'controls';
    }
}

// Cargar mapa de aplicabilidad SOA
function loadSOAApplicabilityMap() {
    fetch('/api/soa-applicability-map')
        .then(response => response.json())
        .then(data => {
            console.log('Datos recibidos:', data);

            if (data.error) {
                document.getElementById('soaApplicabilityMap').innerHTML = `
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>${data.error}
                    </div>`;
                return;
            }

            if (!data.controls || data.controls.length === 0) {
                document.getElementById('soaApplicabilityMap').innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>No hay controles SOA disponibles
                    </div>`;
                return;
            }

            // Construir la tabla HTML
            let html = '<table class="table table-sm table-bordered" style="font-size: 0.85rem;">';

            // Agrupar por dominios
            const domains = {
                '5': { name: 'Controles organizacionales', categories: {} },
                '6': { name: 'Personas', categories: {} },
                '7': { name: 'Seguridad Física', categories: {} },
                '8': { name: 'Técnico', categories: {} }
            };

            // Organizar controles por dominio y categoría
            data.controls.forEach(control => {
                // Extraer el número de dominio: "A.5.1" -> "5"
                // control_id tiene formato "A.X.Y" donde X es el dominio
                const parts = control.control_id.split('.');
                const domainNum = parts[1]; // Obtener el segundo elemento después del split
                const category = control.category;

                // Validar que el dominio existe
                if (!domains[domainNum]) {
                    console.warn(`Dominio no reconocido: ${domainNum} para control ${control.control_id}`);
                    return;
                }

                if (!domains[domainNum].categories[category]) {
                    domains[domainNum].categories[category] = [];
                }
                domains[domainNum].categories[category].push(control);
            });

            // Generar HTML por dominio
            Object.keys(domains).forEach(domainNum => {
                const domain = domains[domainNum];
                const categories = Object.keys(domain.categories);

                if (categories.length === 0) return;

                // Fila de encabezado de dominio
                html += `<tr><td class="fw-bold bg-light" style="width: 30px;">${domainNum}</td>`;
                html += `<td class="fw-bold bg-light" colspan="100">${domain.name}</td></tr>`;

                // Filas por categoría
                categories.forEach(category => {
                    const controls = domain.categories[category];
                    html += `<tr><td></td><td style="width: 200px; background-color: #f8f9fa;">${category}</td>`;

                    controls.forEach(control => {
                        let bgColor = '#6c757d'; // Por defecto: No Aplicable (gris)
                        let textColor = '#fff';

                        if (control.applicability_status === 'aplicable') {
                            bgColor = '#0d6efd'; // Aplicable (azul)
                            textColor = '#fff';
                        } else if (control.applicability_status === 'no_aplicable') {
                            bgColor = '#6c757d'; // No Aplicable (gris)
                            textColor = '#fff';
                        } else if (control.applicability_status === 'transferido') {
                            bgColor = '#ffc107'; // Transferido (amarillo)
                            textColor = '#000';
                        }

                        html += `<td class="text-center p-1" style="background-color: ${bgColor}; color: ${textColor}; min-width: 45px;" title="${control.title}">
                            <small>${control.control_id.replace('A.', '')}</small>
                        </td>`;
                    });

                    html += '</tr>';
                });
            });

            html += '</table>';
            document.getElementById('soaApplicabilityMap').innerHTML = html;
        })
        .catch(error => {
            console.error('Error al cargar mapa de aplicabilidad:', error);
            document.getElementById('soaApplicabilityMap').innerHTML = `
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-circle me-2"></i>Error al cargar el mapa de aplicabilidad
                </div>`;
        });
}

// =================================================================
// CARGAR NUEVAS MÉTRICAS Y GRÁFICOS
// =================================================================

// 1. Cargar alertas críticas
function loadCriticalAlerts() {
    fetch('/api/critical-alerts')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('criticalAlerts').innerHTML = `
                    <div class="alert alert-danger m-3">${data.error}</div>`;
                return;
            }

            document.getElementById('alertsCount').textContent = data.total;

            if (data.alerts.length === 0) {
                document.getElementById('criticalAlerts').innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-check-circle fa-3x mb-2"></i>
                        <p>No hay alertas críticas en este momento</p>
                    </div>`;
                return;
            }

            let html = '';
            data.alerts.slice(0, 10).forEach(alert => {
                const severityClass = {
                    'critical': 'danger',
                    'high': 'warning',
                    'medium': 'info',
                    'low': 'secondary'
                }[alert.severity] || 'secondary';

                html += `
                    <a href="${alert.url}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${alert.title}</h6>
                            <span class="badge bg-${severityClass}">${alert.severity.toUpperCase()}</span>
                        </div>
                        <p class="mb-1 text-muted small">${alert.description}</p>
                    </a>`;
            });

            document.getElementById('criticalAlerts').innerHTML = html;
        })
        .catch(error => {
            console.error('Error al cargar alertas:', error);
        });
}

// 2. Cargar métricas operativas
function loadOperationalMetrics() {
    fetch('/api/operational-metrics')
        .then(response => response.json())
        .then(data => {
            if (data.error) return;

            document.getElementById('taskCompletionRate').textContent = data.task_completion_rate + '%';
            document.getElementById('ncEffectivenessRate').textContent = data.nc_effectiveness_rate + '%';
            document.getElementById('avgIncidentResponse').textContent = data.avg_incident_response_days + ' días';
            document.getElementById('changeSuccessRate').textContent = data.change_success_rate + '%';
        })
        .catch(error => console.error('Error al cargar métricas operativas:', error));
}

// 3. Cargar tendencia de incidentes
function loadIncidentsTrend() {
    fetch('/api/trends/incidents')
        .then(response => response.json())
        .then(data => {
            if (data.error) return;

            const ctx = document.getElementById('incidentsTrendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Total Incidentes',
                        data: data.data,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.4
                    }, {
                        label: 'Críticos/Altos',
                        data: data.critical,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        })
        .catch(error => console.error('Error al cargar tendencia de incidentes:', error));
}

// 4. Cargar distribución de riesgos
function loadRiskDistribution() {
    fetch('/api/trends/risks')
        .then(response => response.json())
        .then(data => {
            if (data.error) return;

            const ctx = document.getElementById('riskDistributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Riesgos por Nivel',
                        data: data.data,
                        backgroundColor: [
                            'rgba(220, 53, 69, 0.7)',
                            'rgba(255, 193, 7, 0.7)',
                            'rgba(13, 202, 240, 0.7)',
                            'rgba(25, 135, 84, 0.7)',
                            'rgba(108, 117, 125, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        })
        .catch(error => console.error('Error al cargar distribución de riesgos:', error));
}

// 5. Cargar mapa de calor de riesgos
function loadRiskHeatmap() {
    fetch('/api/risk-heatmap')
        .then(response => response.json())
        .then(data => {
            if (data.error) return;

            let html = '<table class="table table-bordered text-center">';
            html += '<thead><tr><th>Imp/Prob</th>';
            for (let i = 1; i <= 5; i++) {
                html += `<th>Prob ${i}</th>`;
            }
            html += '</tr></thead><tbody>';

            for (let impact = 5; impact >= 1; impact--) {
                html += `<tr><th>Imp ${impact}</th>`;
                for (let prob = 1; prob <= 5; prob++) {
                    const key = `${impact},${prob}`;
                    const cell = data.matrix[key] || {count: 0};
                    const nivel = impact * prob;

                    let bgColor = '';
                    if (nivel >= 20) bgColor = 'bg-danger';
                    else if (nivel >= 12) bgColor = 'bg-warning';
                    else if (nivel >= 6) bgColor = 'bg-info';
                    else bgColor = 'bg-success';

                    html += `<td class="${bgColor} text-white">${cell.count}</td>`;
                }
                html += '</tr>';
            }
            html += '</tbody></table>';

            document.getElementById('riskHeatmap').innerHTML = html;
        })
        .catch(error => console.error('Error al cargar mapa de calor:', error));
}

// 6. Cargar métricas de auditoría
function loadAuditMetrics() {
    fetch('/api/audit-metrics')
        .then(response => response.json())
        .then(data => {
            if (data.error) return;

            document.getElementById('auditCompletionRate').textContent = data.audit_completion_rate + '%';
            document.getElementById('auditCompletionBar').style.width = data.audit_completion_rate + '%';

            document.getElementById('isoCoverage').textContent = data.iso_coverage_percentage + '%';
            document.getElementById('isoCoverageBar').style.width = data.iso_coverage_percentage + '%';

            document.getElementById('openFindings').textContent = data.open_findings;
            document.getElementById('overdueActions').textContent = data.overdue_corrective_actions;
        })
        .catch(error => console.error('Error al cargar métricas de auditoría:', error));
}

// 7. Cargar distribución de activos
function loadAssetsDistribution() {
    fetch('/api/assets/distribution')
        .then(response => response.json())
        .then(data => {
            if (data.error) return;

            const categories = Object.keys(data.by_category || {});
            const values = Object.values(data.by_category || {});

            if (categories.length === 0) {
                document.getElementById('assetsDistributionChart').parentElement.innerHTML =
                    '<p class="text-muted text-center">Sin datos</p>';
                return;
            }

            const ctx = document.getElementById('assetsDistributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        })
        .catch(error => console.error('Error al cargar distribución de activos:', error));
}

// 8. Cargar distribución de servicios
function loadServicesDistribution() {
    fetch('/api/services/metrics')
        .then(response => response.json())
        .then(data => {
            if (data.error) return;

            const types = Object.keys(data.by_type || {});
            const values = Object.values(data.by_type || {});

            if (types.length === 0) {
                document.getElementById('servicesDistributionChart').parentElement.innerHTML =
                    '<p class="text-muted text-center">Sin datos</p>';
                return;
            }

            const ctx = document.getElementById('servicesDistributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: types,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            'rgba(13, 110, 253, 0.7)',
                            'rgba(25, 135, 84, 0.7)',
                            'rgba(220, 53, 69, 0.7)',
                            'rgba(255, 193, 7, 0.7)',
                            'rgba(108, 117, 125, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        })
        .catch(error => console.error('Error al cargar distribución de servicios:', error));
}

// Cargar ambos gráficos al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // El gráfico de categorías ya se carga arriba
    // Cargar también el gráfico de controles
    setTimeout(loadControlsRadarChart, 500);
    // Cargar mapa de aplicabilidad
    setTimeout(loadSOAApplicabilityMap, 1000);

    // Cargar nuevas métricas
    setTimeout(loadCriticalAlerts, 1500);
    setTimeout(loadOperationalMetrics, 2000);
    setTimeout(loadIncidentsTrend, 2500);
    setTimeout(loadRiskDistribution, 3000);
    setTimeout(loadRiskHeatmap, 3500);
    setTimeout(loadAuditMetrics, 4000);
    setTimeout(loadAssetsDistribution, 4500);
    setTimeout(loadServicesDistribution, 5000);
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Editar Activo - ISMS Manager{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h2"><i class="fas fa-edit me-2"></i>Editar Activo: {{ asset.asset_code }}</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('assets.index') }}">Activos</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('assets.view', id=asset.id) }}">{{ asset.asset_code }}</a></li>
                <li class="breadcrumb-item active">Editar</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-body">
                <form method="POST" action="{{ url_for('assets.edit', id=asset.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <h5 class="card-title mb-4"><i class="fas fa-info-circle me-2"></i>Información Básica</h5>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Nombre del Activo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ asset.name }}" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="category" class="form-label">Categoría <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" value="{{ asset.category.value }}" disabled>
                            <input type="hidden" id="category" name="category" value="{{ asset.category.name }}">
                            <small class="text-muted">No se puede cambiar la categoría</small>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="asset_type_id" class="form-label">Tipo de Activo</label>
                            <select class="form-select" id="asset_type_id" name="asset_type_id">
                                <option value="">Cargando tipos...</option>
                            </select>
                            <small class="text-muted">Según la categoría</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Descripción</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ asset.description or '' }}</textarea>
                    </div>

                    <hr class="my-4">

                    <h5 class="card-title mb-4"><i class="fas fa-user-shield me-2"></i>Responsables</h5>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="owner_id" class="form-label">Propietario del Activo <span class="text-danger">*</span></label>
                            <select class="form-select" id="owner_id" name="owner_id" required>
                                <option value="">Seleccionar propietario...</option>
                                {% for user in users %}
                                <option value="{{ user.id }}" {% if asset.owner_id == user.id %}selected{% endif %}>{{ user.first_name }} {{ user.last_name }} ({{ user.email }})</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Requerido por Control 5.9</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="custodian_id" class="form-label">Custodio/Responsable Técnico</label>
                            <select class="form-select" id="custodian_id" name="custodian_id">
                                <option value="">Seleccionar custodio...</option>
                                {% for user in users %}
                                <option value="{{ user.id }}" {% if asset.custodian_id == user.id %}selected{% endif %}>{{ user.first_name }} {{ user.last_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <hr class="my-4">

                    <h5 class="card-title mb-4"><i class="fas fa-lock me-2"></i>Clasificación de Seguridad (Control 5.12)</h5>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="classification" class="form-label">Clasificación <span class="text-danger">*</span></label>
                            <select class="form-select" id="classification" name="classification" required>
                                {% for cls in ClassificationLevel %}
                                <option value="{{ cls.name }}" {% if asset.classification and asset.classification.name == cls.name %}selected{% endif %}>
                                    {{ cls.value }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="confidentiality_level" class="form-label">Confidencialidad <span class="text-danger">*</span></label>
                            <select class="form-select" id="confidentiality_level" name="confidentiality_level" required>
                                {% for lvl in CIALevel %}
                                <option value="{{ lvl.name }}" {% if asset.confidentiality_level and asset.confidentiality_level.name == lvl.name %}selected{% endif %}>
                                    {{ lvl.value }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="integrity_level" class="form-label">Integridad <span class="text-danger">*</span></label>
                            <select class="form-select" id="integrity_level" name="integrity_level" required>
                                {% for lvl in CIALevel %}
                                <option value="{{ lvl.name }}" {% if asset.integrity_level and asset.integrity_level.name == lvl.name %}selected{% endif %}>
                                    {{ lvl.value }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="availability_level" class="form-label">Disponibilidad <span class="text-danger">*</span></label>
                            <select class="form-select" id="availability_level" name="availability_level" required>
                                {% for lvl in CIALevel %}
                                <option value="{{ lvl.name }}" {% if asset.availability_level and asset.availability_level.name == lvl.name %}selected{% endif %}>
                                    {{ lvl.value }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Cálculo Automático:</strong> El Valor de Negocio y la Criticidad se calculan automáticamente
                        basándose en la Clasificación, CIA y Coste. Puedes ajustarlos manualmente si es necesario.
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="business_value" class="form-label">
                                Valor de Negocio (1-10)
                                <i class="fas fa-question-circle text-muted"
                                   title="Calculado automáticamente: Clasificación (40%) + Coste (30%) + CIA promedio (30%)"
                                   data-bs-toggle="tooltip"></i>
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-light" id="business_value_display_readonly"
                                       min="1" max="10" value="{{ asset.business_value or '' }}" readonly
                                       title="Valor calculado automáticamente - haz clic en 'Ajustar' para modificar manualmente">
                                <input type="hidden" id="business_value" name="business_value" value="{{ asset.business_value or '' }}">
                                <button class="btn btn-outline-primary" type="button" id="manual_business_value_btn"
                                        title="Ajustar manualmente">
                                    <i class="fas fa-edit"></i> Ajustar
                                </button>
                            </div>
                            <small class="text-muted" id="business_value_info">
                                <i class="fas fa-robot"></i> Calculado automáticamente
                            </small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="criticality" class="form-label">
                                Criticidad (1-10)
                                <i class="fas fa-question-circle text-muted"
                                   title="Calculado automáticamente: Disponibilidad (50%) + Integridad (30%) + Confidencialidad (20%)"
                                   data-bs-toggle="tooltip"></i>
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-light" id="criticality_display_readonly"
                                       min="1" max="10" value="{{ asset.criticality or '' }}" readonly
                                       title="Valor calculado automáticamente - haz clic en 'Ajustar' para modificar manualmente">
                                <input type="hidden" id="criticality" name="criticality" value="{{ asset.criticality or '' }}">
                                <button class="btn btn-outline-primary" type="button" id="manual_criticality_btn"
                                        title="Ajustar manualmente">
                                    <i class="fas fa-edit"></i> Ajustar
                                </button>
                            </div>
                            <small class="text-muted" id="criticality_info">
                                <i class="fas fa-robot"></i> Calculado automáticamente
                            </small>
                        </div>
                    </div>

                    <hr class="my-4">

                    <h5 class="card-title mb-4"><i class="fas fa-map-marker-alt me-2"></i>Ubicación</h5>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="physical_location" class="form-label">Ubicación Física</label>
                            <input type="text" class="form-control" id="physical_location" name="physical_location">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="logical_location" class="form-label">Ubicación Lógica</label>
                            <input type="text" class="form-control" id="logical_location" name="logical_location">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="department" class="form-label">Departamento</label>
                            <input type="text" class="form-control" id="department" name="department">
                        </div>
                    </div>

                    <hr class="my-4">

                    <h5 class="card-title mb-4"><i class="fas fa-info me-2"></i>Información Técnica</h5>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="manufacturer" class="form-label">Fabricante</label>
                            <input type="text" class="form-control" id="manufacturer" name="manufacturer">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="model" class="form-label">Modelo</label>
                            <input type="text" class="form-control" id="model" name="model">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="serial_number" class="form-label">Número de Serie</label>
                            <input type="text" class="form-control" id="serial_number" name="serial_number">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="version" class="form-label">Versión</label>
                            <input type="text" class="form-control" id="version" name="version">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="acquisition_date" class="form-label">Fecha de Adquisición</label>
                            <input type="date" class="form-control" id="acquisition_date" name="acquisition_date">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="purchase_cost" class="form-label">Coste de Adquisición (€)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase_cost" name="purchase_cost">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="current_value" class="form-label">Valor Actual (€)</label>
                            <div class="input-group">
                                <input type="number" step="0.01" class="form-control" id="current_value" name="current_value" readonly>
                                <button class="btn btn-outline-secondary" type="button" id="calculate_value_btn" title="Calcular valor automáticamente">
                                    <i class="fas fa-calculator"></i>
                                </button>
                                <button class="btn btn-outline-primary" type="button" id="manual_value_btn" title="Introducir valor manualmente">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <small class="text-muted" id="depreciation_info"></small>
                        </div>
                    </div>

                    <hr class="my-4">

                    <h5 class="card-title mb-4"><i class="fas fa-file-alt me-2"></i>Políticas y Requisitos</h5>

                    <div class="mb-3">
                        <label for="tags" class="form-label">Etiquetas</label>
                        <input type="text" class="form-control" id="tags" name="tags"
                               placeholder="Ej: Producción, Crítico, PCI-DSS">
                        <small class="text-muted">Separar con comas</small>
                    </div>

                    <div class="mb-3">
                        <label for="acceptable_use_policy" class="form-label">Política de Uso Aceptable (Control 5.10)</label>
                        <textarea class="form-control" id="acceptable_use_policy" name="acceptable_use_policy" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="handling_requirements" class="form-label">Requisitos de Manejo</label>
                        <textarea class="form-control" id="handling_requirements" name="handling_requirements" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notas Adicionales</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>

                    <hr class="my-4">

                    <h5 class="card-title mb-4"><i class="fas fa-cog me-2"></i>Estado del Activo</h5>
                    <div class="mb-4">
                        <label for="status" class="form-label">Estado <span class="text-danger">*</span></label>
                        <select class="form-select" id="status" name="status" required>
                            {% for st in AssetStatus %}
                            <option value="{{ st.name }}" {% if asset.status and asset.status.name == st.name %}selected{% endif %}>
                                {{ st.value }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('assets.view', id=asset.id) }}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Actualizar Activo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Estado de los campos: true = automático, false = manual
let isBusinessValueAuto = true;
let isCriticalityAuto = true;

// Funciones de cálculo automático de Valor de Negocio y Criticidad
function calculateBusinessValue() {
    if (!isBusinessValueAuto) return; // No calcular si es manual

    const classificationScores = {
        'PUBLIC': 2,
        'INTERNAL': 5,
        'CONFIDENTIAL': 8,
        'RESTRICTED': 10
    };

    const ciaScores = {
        'LOW': 2,
        'MEDIUM': 5,
        'HIGH': 8,
        'CRITICAL': 10
    };

    const classification = document.getElementById('classification').value;
    const confidentiality = document.getElementById('confidentiality_level').value;
    const integrity = document.getElementById('integrity_level').value;
    const availability = document.getElementById('availability_level').value;
    const cost = parseFloat(document.getElementById('purchase_cost').value) ||
                 parseFloat(document.getElementById('current_value').value) || 0;

    const classValue = (classificationScores[classification] || 5) * 0.4;

    let costValue = 1;
    if (cost < 1000) costValue = 2;
    else if (cost < 5000) costValue = 4;
    else if (cost < 10000) costValue = 5;
    else if (cost < 25000) costValue = 6;
    else if (cost < 50000) costValue = 8;
    else if (cost < 100000) costValue = 9;
    else if (cost >= 100000) costValue = 10;
    const costComponent = costValue * 0.3;

    const cScore = ciaScores[confidentiality] || 5;
    const iScore = ciaScores[integrity] || 5;
    const aScore = ciaScores[availability] || 5;
    const ciaAverage = (cScore + iScore + aScore) / 3;
    const ciaComponent = ciaAverage * 0.3;

    const total = Math.round(Math.max(1, Math.min(10, classValue + costComponent + ciaComponent)));

    // Actualizar campos
    document.getElementById('business_value').value = total;
    document.getElementById('business_value_display_readonly').value = total;
    document.getElementById('business_value_info').innerHTML =
        `<i class="fas fa-robot"></i> <span class="text-success">Calculado automáticamente: ${total}/10</span>`;

    return total;
}

function calculateCriticality() {
    if (!isCriticalityAuto) return; // No calcular si es manual

    const ciaScores = {
        'LOW': 2,
        'MEDIUM': 5,
        'HIGH': 8,
        'CRITICAL': 10
    };

    const confidentiality = document.getElementById('confidentiality_level').value;
    const integrity = document.getElementById('integrity_level').value;
    const availability = document.getElementById('availability_level').value;

    const aScore = (ciaScores[availability] || 5) * 0.5;
    const iScore = (ciaScores[integrity] || 5) * 0.3;
    const cScore = (ciaScores[confidentiality] || 5) * 0.2;

    const total = Math.round(Math.max(1, Math.min(10, aScore + iScore + cScore)));

    // Actualizar campos
    document.getElementById('criticality').value = total;
    document.getElementById('criticality_display_readonly').value = total;
    document.getElementById('criticality_info').innerHTML =
        `<i class="fas fa-robot"></i> <span class="text-success">Calculado automáticamente: ${total}/10</span>`;

    return total;
}

// Botones para cambiar a modo manual
document.getElementById('manual_business_value_btn').addEventListener('click', function() {
    isBusinessValueAuto = !isBusinessValueAuto;

    const displayField = document.getElementById('business_value_display_readonly');
    const btn = this;

    if (isBusinessValueAuto) {
        // Cambiar a modo automático
        displayField.readOnly = true;
        displayField.classList.add('bg-light');
        btn.innerHTML = '<i class="fas fa-edit"></i> Ajustar';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-primary');
        calculateBusinessValue();
    } else {
        // Cambiar a modo manual
        displayField.readOnly = false;
        displayField.classList.remove('bg-light');
        displayField.focus();
        btn.innerHTML = '<i class="fas fa-robot"></i> Auto';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        document.getElementById('business_value_info').innerHTML =
            `<i class="fas fa-user-edit"></i> <span class="text-primary">Valor ajustado manualmente</span>`;
    }
});

document.getElementById('manual_criticality_btn').addEventListener('click', function() {
    isCriticalityAuto = !isCriticalityAuto;

    const displayField = document.getElementById('criticality_display_readonly');
    const btn = this;

    if (isCriticalityAuto) {
        // Cambiar a modo automático
        displayField.readOnly = true;
        displayField.classList.add('bg-light');
        btn.innerHTML = '<i class="fas fa-edit"></i> Ajustar';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-primary');
        calculateCriticality();
    } else {
        // Cambiar a modo manual
        displayField.readOnly = false;
        displayField.classList.remove('bg-light');
        displayField.focus();
        btn.innerHTML = '<i class="fas fa-robot"></i> Auto';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        document.getElementById('criticality_info').innerHTML =
            `<i class="fas fa-user-edit"></i> <span class="text-primary">Valor ajustado manualmente</span>`;
    }
});

// Sincronizar valores cuando se edita manualmente
document.getElementById('business_value_display_readonly').addEventListener('input', function() {
    document.getElementById('business_value').value = this.value;
});

document.getElementById('criticality_display_readonly').addEventListener('input', function() {
    document.getElementById('criticality').value = this.value;
});

// Calcular automáticamente cuando cambien campos relevantes (EN TIEMPO REAL)
['classification', 'confidentiality_level', 'integrity_level', 'availability_level', 'purchase_cost', 'current_value'].forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
        // Usar 'input' para tiempo real en lugar de 'change'
        field.addEventListener('input', function() {
            calculateBusinessValue();
            calculateCriticality();
        });
        // También en 'change' para selects
        field.addEventListener('change', function() {
            calculateBusinessValue();
            calculateCriticality();
        });
    }
});

// Inicializar tooltips de Bootstrap
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});

// Cargar tipos de activo según la categoría actual
document.addEventListener('DOMContentLoaded', function() {
    const category = document.getElementById('category').value;
    const assetTypeSelect = document.getElementById('asset_type_id');
    const currentAssetTypeId = {{ asset.asset_type_id if asset.asset_type_id else 'null' }};

    if (category) {
        // Hacer petición AJAX para obtener tipos
        fetch(`/activos/api/asset-types/${category}`)
            .then(response => response.json())
            .then(data => {
                assetTypeSelect.innerHTML = '<option value="">Seleccionar tipo...</option>';

                data.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = type.name;
                    option.title = type.description;

                    // Preseleccionar el tipo actual
                    if (type.id === currentAssetTypeId) {
                        option.selected = true;
                    }

                    assetTypeSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error cargando tipos:', error);
                assetTypeSelect.innerHTML = '<option value="">Error cargando tipos</option>';
            });
    }
});

// Inicializar valores de campos
document.getElementById('physical_location').value = '{{ asset.physical_location or '' }}';
document.getElementById('logical_location').value = '{{ asset.logical_location or '' }}';
document.getElementById('department').value = '{{ asset.department or '' }}';
document.getElementById('manufacturer').value = '{{ asset.manufacturer or '' }}';
document.getElementById('model').value = '{{ asset.model or '' }}';
document.getElementById('serial_number').value = '{{ asset.serial_number or '' }}';
document.getElementById('version').value = '{{ asset.version or '' }}';
document.getElementById('tags').value = '{{ asset.tags or '' }}';
document.getElementById('acceptable_use_policy').value = '{{ asset.acceptable_use_policy or '' }}';
document.getElementById('handling_requirements').value = '{{ asset.handling_requirements or '' }}';
document.getElementById('notes').value = '{{ asset.notes or '' }}';

{% if asset.acquisition_date %}
document.getElementById('acquisition_date').value = '{{ asset.acquisition_date.strftime("%Y-%m-%d") }}';
{% endif %}
{% if asset.purchase_cost %}
document.getElementById('purchase_cost').value = {{ asset.purchase_cost }};
{% endif %}
{% if asset.current_value %}
document.getElementById('current_value').value = {{ asset.current_value }};
{% endif %}

// Sistema de cálculo de depreciación
let isManualValue = {{ 'true' if asset.current_value else 'false' }};

document.getElementById('manual_value_btn').addEventListener('click', function() {
    isManualValue = true;
    document.getElementById('current_value').readOnly = false;
    document.getElementById('current_value').focus();
    document.getElementById('depreciation_info').textContent = 'Valor manual';
});

document.getElementById('calculate_value_btn').addEventListener('click', function() {
    calculateDepreciation();
});

// Calcular automáticamente cuando cambien los campos relevantes
['purchase_cost', 'acquisition_date'].forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
        field.addEventListener('change', function() {
            if (!isManualValue) {
                calculateDepreciation();
            }
        });
    }
});

function calculateDepreciation() {
    const category = document.getElementById('category').value;
    const purchaseCost = parseFloat(document.getElementById('purchase_cost').value);
    const acquisitionDate = document.getElementById('acquisition_date').value;

    if (!category || !purchaseCost || !acquisitionDate) {
        document.getElementById('depreciation_info').textContent = 'Completa categoría, coste y fecha';
        document.getElementById('current_value').value = '';
        return;
    }

    // Obtener token CSRF
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;

    // Llamar a la API para calcular depreciación
    fetch('/admin/api/depreciation/calculate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            category: category,
            purchase_cost: purchaseCost,
            acquisition_date: acquisitionDate
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Error response:', text);
                throw new Error(`HTTP error! status: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            document.getElementById('depreciation_info').textContent = 'Error: ' + data.error;
            return;
        }

        isManualValue = false;
        document.getElementById('current_value').value = data.current_value;
        document.getElementById('current_value').readOnly = true;

        const infoText = `Depreciación: ${data.depreciation.toFixed(2)}€ en ${data.years_elapsed.toFixed(1)} años (${data.depreciation_years} años vida útil)`;
        document.getElementById('depreciation_info').textContent = infoText;
    })
    .catch(error => {
        console.error('Error calculando depreciación:', error);
        document.getElementById('depreciation_info').textContent = 'Error al calcular: ' + error.message;
    });
}

// Calcular automáticamente al cargar si no hay valor manual
if (!isManualValue && document.getElementById('purchase_cost').value && document.getElementById('acquisition_date').value) {
    setTimeout(calculateDepreciation, 500);
}
</script>
{% endblock %}

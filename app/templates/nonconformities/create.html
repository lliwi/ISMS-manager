{% extends "base.html" %}

{% block title %}Nueva No Conformidad - SGSI{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-plus-circle text-primary"></i>
                        Registrar Nueva No Conformidad
                    </h1>
                    <p class="text-muted mb-0">
                        <small>ISO 27001:2023 - Cap칤tulo 10.2 | No conformidad y acciones correctivas</small>
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('nonconformities.index') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Wizard Form -->
    <div class="card">
        <div class="card-body">
            <form method="POST" action="{{ url_for('nonconformities.create') }}" id="ncForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <!-- Paso 1: Informaci칩n B치sica -->
                <div class="wizard-step" id="step1">
                    <h4 class="mb-4">
                        <span class="badge bg-primary">1</span>
                        Informaci칩n B치sica
                    </h4>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="title" class="form-label required">T칤tulo *</label>
                            <input type="text" class="form-control" id="title" name="title"
                                   required maxlength="255"
                                   placeholder="Ej: Falta de control de acceso en servidor de producci칩n">
                            <div class="form-text">Descripci칩n breve y clara de la no conformidad</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="description" class="form-label required">Descripci칩n Detallada *</label>
                            <textarea class="form-control" id="description" name="description"
                                      rows="5" required
                                      placeholder="Describa la no conformidad en detalle: 쯈u칠 sucedi칩? 쮻칩nde? 쮺u치ndo? 쯈ui칠n lo detect칩?"></textarea>
                            <div class="form-text">Proporcione todos los detalles relevantes (10.2.f - naturaleza de la no conformidad)</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="origin" class="form-label required">Origen *</label>
                            <select class="form-select" id="origin" name="origin" required>
                                <option value="">Seleccione...</option>
                                {% for origin in NCOrigin %}
                                <option value="{{ origin.name }}">{{ origin.value }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label for="severity" class="form-label required">Severidad *</label>
                            <select class="form-select" id="severity" name="severity" required>
                                <option value="">Seleccione...</option>
                                {% for severity in NCSeverity %}
                                <option value="{{ severity.name }}">{{ severity.value }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <small>
                                    <strong>Menor:</strong> Bajo impacto<br>
                                    <strong>Mayor:</strong> Impacto significativo<br>
                                    <strong>Cr칤tica:</strong> Impacto grave en el SGSI
                                </small>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label for="detection_date" class="form-label required">Fecha de Detecci칩n *</label>
                            <input type="datetime-local" class="form-control" id="detection_date"
                                   name="detection_date" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="responsible_id" class="form-label required">Responsable *</label>
                            <select class="form-select" id="responsible_id" name="responsible_id" required>
                                <option value="">Seleccione...</option>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.name }} - {{ user.position or '' }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Persona responsable de gestionar esta NC</div>
                        </div>

                        <div class="col-md-6">
                            <label for="target_closure_date" class="form-label">Fecha Objetivo de Cierre</label>
                            <input type="date" class="form-control" id="target_closure_date"
                                   name="target_closure_date">
                            <div class="form-text">Fecha prevista para resolver la NC</div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-12">
                            <label for="immediate_action" class="form-label">Acci칩n Inmediata Tomada</label>
                            <textarea class="form-control" id="immediate_action" name="immediate_action"
                                      rows="3"
                                      placeholder="Describa cualquier acci칩n inmediata que se haya tomado para controlar la situaci칩n (ISO 10.2.a)"></textarea>
                            <div class="form-text">10.2.a - Acciones para controlar y corregir</div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" disabled>
                            <i class="fas fa-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep(2)">
                            Siguiente <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Paso 2: Contexto y Relaciones -->
                <div class="wizard-step d-none" id="step2">
                    <h4 class="mb-4">
                        <span class="badge bg-primary">2</span>
                        Contexto y Relaciones
                    </h4>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Controles ISO 27001 Afectados</label>

                            <!-- Filtro de controles -->
                            <div class="mb-2">
                                <input type="text" class="form-control form-control-sm" id="control-filter"
                                       placeholder="游댌 Buscar controles por ID, t칤tulo o categor칤a...">
                            </div>

                            <!-- Contador de controles -->
                            <div class="mb-2">
                                <small class="text-muted">
                                    <span id="selected-count">0</span> controles seleccionados de
                                    <span id="total-count">{{ controls|length }}</span>
                                </small>
                            </div>

                            <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;" id="controls-container">
                                <div class="row" id="controls-list">
                                    {% for control in controls %}
                                    <div class="col-md-12 mb-2 control-item" data-control-text="{{ control.control_id|lower }} {{ control.title|lower }} {{ control.category|lower }}">
                                        <div class="form-check">
                                            <input class="form-check-input control-checkbox" type="checkbox"
                                                   name="affected_controls" value="{{ control.control_id }}"
                                                   id="control_{{ control.id }}">
                                            <label class="form-check-label" for="control_{{ control.id }}" style="cursor: pointer;">
                                                <code class="text-primary">{{ control.control_id }}</code>
                                                <strong>{{ control.title }}</strong>
                                                <br><small class="text-muted">{{ control.category }}</small>
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div id="no-results" class="alert alert-warning mt-2" style="display: none;">
                                <i class="fas fa-search me-2"></i>No se encontraron controles que coincidan con la b칰squeda.
                            </div>

                            <div class="form-text">Seleccione los controles del Anexo A que est치n afectados</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="audit_id" class="form-label">Auditor칤a Relacionada</label>
                            <select class="form-select" id="audit_id" name="audit_id">
                                <option value="">Ninguna</option>
                                {% for audit in audits %}
                                <option value="{{ audit.id }}">{{ audit.title }} - {{ audit.audit_type }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Si la NC proviene de una auditor칤a</div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Activos Afectados</label>
                            <select class="form-select" id="asset_ids" name="asset_ids" multiple size="5">
                                {% for asset in assets %}
                                <option value="{{ asset.id }}">{{ asset.asset_code }} - {{ asset.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Mantenga Ctrl/Cmd para selecci칩n m칰ltiple</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_recurrent"
                                       name="is_recurrent" onchange="toggleRecurrent()">
                                <label class="form-check-label" for="is_recurrent">
                                    <strong>Es una NC recurrente</strong>
                                    <small class="text-muted">(10.2.b.3 - NC similares)</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4 d-none" id="recurrent_section">
                        <div class="col-md-12">
                            <label for="related_nc_id" class="form-label">NC Anterior Relacionada</label>
                            <input type="text" class="form-control" id="related_nc_id" name="related_nc_id"
                                   placeholder="Ingrese el c칩digo de la NC anterior">
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-12">
                            <label for="notes" class="form-label">Notas Adicionales</label>
                            <textarea class="form-control" id="notes" name="notes"
                                      rows="3" placeholder="Cualquier informaci칩n adicional relevante"></textarea>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="prevStep(1)">
                            <i class="fas fa-arrow-left"></i> Anterior
                        </button>
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="prevStep(1)">
                                Guardar como borrador
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check"></i> Registrar No Conformidad
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Ayuda contextual -->
    <div class="card mt-4 border-info">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <i class="fas fa-info-circle"></i> Informaci칩n importante
            </h5>
        </div>
        <div class="card-body">
            <h6>쯈u칠 es una No Conformidad?</h6>
            <p>
                Seg칰n ISO 27001:2023, una no conformidad es el <strong>incumplimiento de un requisito</strong>.
                Esto puede incluir:
            </p>
            <ul class="mb-3">
                <li>No cumplimiento de requisitos del SGSI</li>
                <li>No cumplimiento de requisitos de ISO 27001</li>
                <li>Desviaciones de pol칤ticas o procedimientos</li>
                <li>Hallazgos de auditor칤as</li>
                <li>Incidentes que revelan deficiencias en el sistema</li>
            </ul>

            <h6>Proceso seg칰n ISO 27001 (Cap칤tulo 10.2):</h6>
            <ol>
                <li><strong>Reaccionar:</strong> Tomar acciones para controlar y corregir</li>
                <li><strong>Evaluar:</strong> Determinar si existen NC similares</li>
                <li><strong>Analizar:</strong> Realizar an치lisis de causa ra칤z</li>
                <li><strong>Implementar:</strong> Ejecutar acciones correctivas</li>
                <li><strong>Revisar:</strong> Verificar eficacia de las acciones</li>
                <li><strong>Documentar:</strong> Mantener informaci칩n documentada</li>
            </ol>
        </div>
    </div>
</div>

<script>
    // Wizard navigation
    function nextStep(step) {
        // Validar paso actual
        if (step === 2) {
            const form = document.getElementById('ncForm');
            const requiredFields = form.querySelectorAll('#step1 [required]');
            let valid = true;

            requiredFields.forEach(field => {
                if (!field.value) {
                    valid = false;
                    field.classList.add('is-invalid');
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            if (!valid) {
                alert('Por favor complete todos los campos obligatorios marcados con *');
                return;
            }
        }

        // Ocultar todos los pasos
        document.querySelectorAll('.wizard-step').forEach(s => s.classList.add('d-none'));
        // Mostrar paso seleccionado
        document.getElementById('step' + step).classList.remove('d-none');
    }

    function prevStep(step) {
        document.querySelectorAll('.wizard-step').forEach(s => s.classList.add('d-none'));
        document.getElementById('step' + step).classList.remove('d-none');
    }

    function toggleRecurrent() {
        const checkbox = document.getElementById('is_recurrent');
        const section = document.getElementById('recurrent_section');

        if (checkbox.checked) {
            section.classList.remove('d-none');
        } else {
            section.classList.add('d-none');
        }
    }

    // Set default detection date to now
    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('detection_date').value = now.toISOString().slice(0, 16);

        // Filtrado de controles
        const filterInput = document.getElementById('control-filter');
        const controlItems = document.querySelectorAll('.control-item');
        const controlCheckboxes = document.querySelectorAll('.control-checkbox');
        const selectedCount = document.getElementById('selected-count');
        const noResults = document.getElementById('no-results');

        // Funci칩n para actualizar el contador de seleccionados
        function updateSelectedCount() {
            const checked = document.querySelectorAll('.control-checkbox:checked').length;
            if (selectedCount) {
                selectedCount.textContent = checked;
            }
        }

        // Filtro de controles
        if (filterInput) {
            filterInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                let visibleCount = 0;

                controlItems.forEach(item => {
                    const controlText = item.getAttribute('data-control-text');

                    if (controlText.includes(searchTerm)) {
                        item.style.display = '';
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                // Mostrar/ocultar mensaje de "no results"
                if (noResults) {
                    if (visibleCount === 0 && searchTerm !== '') {
                        noResults.style.display = 'block';
                    } else {
                        noResults.style.display = 'none';
                    }
                }
            });
        }

        // Actualizar contador cuando se marcan/desmarcan checkboxes
        controlCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });

        // Inicializar contador
        updateSelectedCount();
    });

    // Form validation
    document.getElementById('ncForm').addEventListener('submit', function(e) {
        const form = this;
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        form.classList.add('was-validated');
    });
</script>

<style>
    .required::after {
        content: " *";
        color: red;
    }

    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .wizard-step {
        min-height: 400px;
    }

    .is-invalid {
        border-color: #dc3545;
    }

    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }
</style>
{% endblock %}

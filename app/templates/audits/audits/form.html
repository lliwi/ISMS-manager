{% extends "base.html" %}
{% block title %}{{ 'Editar' if audit else 'Nueva' }} Auditoría - ISO 27001{% endblock %}

{% block extra_head %}
<link href="{{ url_for('static', filename='vendor/select2/select2.min.css') }}" rel="stylesheet" />
<link href="{{ url_for('static', filename='vendor/select2/select2-bootstrap-5-theme.min.css') }}" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>
                <i class="fas fa-clipboard-check me-2"></i>
                {{ 'Editar Auditoría' if audit else 'Nueva Auditoría' }}
            </h2>
            <p class="text-muted">
                ISO 27001:2022 - Cláusula 9.2 - Auditoría interna del SGSI
            </p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('audits.audits_list') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
        </div>
    </div>

    <form method="POST" action="{{ url_for('audits.audit_create') if not audit else url_for('audits.audit_edit', id=audit.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="row">
            <!-- Columna Principal -->
            <div class="col-md-8">
                <!-- Información Básica -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Información de la Auditoría
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="audit_type" class="form-label">Tipo de Auditoría <span class="text-danger">*</span></label>
                                <select class="form-select" id="audit_type" name="audit_type" required>
                                    <option value="">Seleccione...</option>
                                    <option value="INTERNAL_PLANNED" {% if audit and audit.audit_type.name == 'INTERNAL_PLANNED' %}selected{% endif %}>
                                        Auditoría Interna Planificada
                                    </option>
                                    <option value="INTERNAL_EXTRAORDINARY" {% if audit and audit.audit_type.name == 'INTERNAL_EXTRAORDINARY' %}selected{% endif %}>
                                        Auditoría Interna Extraordinaria
                                    </option>
                                    <option value="EXTERNAL_CERTIFICATION" {% if audit and audit.audit_type.name == 'EXTERNAL_CERTIFICATION' %}selected{% endif %}>
                                        Auditoría Externa de Certificación
                                    </option>
                                    <option value="EXTERNAL_SURVEILLANCE" {% if audit and audit.audit_type.name == 'EXTERNAL_SURVEILLANCE' %}selected{% endif %}>
                                        Auditoría Externa de Seguimiento
                                    </option>
                                    <option value="MANAGEMENT_REVIEW" {% if audit and audit.audit_type.name == 'MANAGEMENT_REVIEW' %}selected{% endif %}>
                                        Revisión por la Dirección
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="audit_program_id" class="form-label">Programa de Auditoría</label>
                                <select class="form-select" id="audit_program_id" name="audit_program_id">
                                    <option value="">Ninguno (auditoría extraordinaria)</option>
                                    {% for program in programs %}
                                    <option value="{{ program.id }}"
                                            {% if audit and audit.audit_program_id == program.id %}selected{% endif %}>
                                        Programa {{ program.year }} - {{ program.title }}
                                        {% if program.status.name == 'APPROVED' %}
                                            (Aprobado)
                                        {% elif program.status.name == 'DRAFT' %}
                                            (Borrador)
                                        {% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    {% if programs %}
                                        Vincular con programa anual (opcional)
                                    {% else %}
                                        <span class="text-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            No hay programas disponibles.
                                            <a href="{{ url_for('audits.program_create') }}">Crear programa</a>
                                        </span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="title" class="form-label">Título de la Auditoría <span class="text-danger">*</span></label>
                            <input type="text"
                                   class="form-control"
                                   id="title"
                                   name="title"
                                   value="{{ audit.title if audit else '' }}"
                                   placeholder="Ej: Auditoría Interna SGSI - Controles de Acceso"
                                   required>
                        </div>

                        <div class="mb-3">
                            <label for="scope" class="form-label">Alcance <span class="text-danger">*</span></label>
                            <textarea class="form-control"
                                      id="scope"
                                      name="scope"
                                      rows="4"
                                      placeholder="Define el alcance de la auditoría: áreas, procesos, controles ISO 27001 a evaluar..."
                                      required>{{ audit.scope if audit else '' }}</textarea>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Especificar qué áreas, procesos y controles serán auditados
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="objectives" class="form-label">Objetivos</label>
                            <textarea class="form-control"
                                      id="objectives"
                                      name="objectives"
                                      rows="3"
                                      placeholder="Objetivos específicos de esta auditoría...">{{ audit.objectives if audit else '' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="audit_criteria" class="form-label">Criterios de Auditoría</label>
                            <textarea class="form-control"
                                      id="audit_criteria"
                                      name="audit_criteria"
                                      rows="3"
                                      placeholder="ISO 27001:2022, políticas internas, procedimientos...">{{ audit.audit_criteria if audit else 'ISO/IEC 27001:2022, ISO/IEC 27002:2022, Políticas y procedimientos del SGSI' }}</textarea>
                            <small class="form-text text-muted">Normas, políticas y requisitos contra los que se evaluará</small>
                        </div>
                    </div>
                </div>

                <!-- Planificación Temporal -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar me-2"></i>
                            Planificación Temporal
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="planned_date" class="form-label">Fecha Planificada</label>
                                <input type="date"
                                       class="form-control"
                                       id="planned_date"
                                       name="planned_date"
                                       value="{{ audit.planned_date.strftime('%Y-%m-%d') if audit and audit.planned_date else '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="start_date" class="form-label">Fecha Inicio</label>
                                <input type="date"
                                       class="form-control"
                                       id="start_date"
                                       name="start_date"
                                       value="{{ audit.start_date.strftime('%Y-%m-%d') if audit and audit.start_date else '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="end_date" class="form-label">Fecha Fin</label>
                                <input type="date"
                                       class="form-control"
                                       id="end_date"
                                       name="end_date"
                                       value="{{ audit.end_date.strftime('%Y-%m-%d') if audit and audit.end_date else '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Equipo Auditor -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>
                            Equipo Auditor
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="lead_auditor_id" class="form-label">Auditor Líder <span class="text-danger">*</span></label>
                            <select class="form-select select2"
                                    id="lead_auditor_id"
                                    name="lead_auditor_id"
                                    required>
                                <option value="">Seleccione auditor líder...</option>
                                {% for user in qualified_auditors %}
                                <option value="{{ user.id }}"
                                        {% if audit and audit.lead_auditor_id == user.id %}selected{% endif %}>
                                    {{ user.full_name }}{% if user.email %} ({{ user.email }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">
                                <i class="fas fa-shield-alt me-1"></i>
                                Seleccione el auditor líder responsable de la auditoría
                            </small>
                        </div>

                        {% if not audit %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Podrás agregar más miembros al equipo auditor después de crear la auditoría
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Áreas y Controles -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-sitemap me-2"></i>
                            Áreas y Controles a Auditar
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="audited_areas" class="form-label">Áreas/Departamentos</label>
                            <select class="form-select select2"
                                    id="audited_areas"
                                    name="audited_areas"
                                    multiple>
                                {% for area in organizational_areas %}
                                <option value="{{ area }}">{{ area }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Seleccionar áreas organizacionales a auditar</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Controles ISO 27001 a Auditar</label>

                            {% if controls %}
                            <!-- Filtro de controles -->
                            <div class="mb-3">
                                <input type="text" class="form-control" id="control-filter"
                                       placeholder="🔍 Buscar controles por ID, título o categoría...">
                            </div>

                            <!-- Contador de controles -->
                            <div class="mb-2">
                                <small class="text-muted">
                                    <span id="selected-count">0</span> controles seleccionados de
                                    <span id="total-count">{{ controls|length }}</span>
                                </small>
                            </div>

                            <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto;" id="controls-container">
                                <div class="row" id="controls-list">
                                    {% for control in controls %}
                                    <div class="col-md-12 mb-2 control-item" data-control-text="{{ control.control_id|lower }} {{ control.title|lower }} {{ control.category|lower }}">
                                        <div class="form-check">
                                            <input class="form-check-input control-checkbox" type="checkbox"
                                                   name="audited_controls[]" value="{{ control.id }}"
                                                   id="control_{{ control.id }}"
                                                   {% if selected_controls and (control.id|string in selected_controls or control.control_id in selected_controls) %}checked{% endif %}>
                                            <label class="form-check-label" for="control_{{ control.id }}" style="cursor: pointer;">
                                                <code class="text-primary">{{ control.control_id }}</code>
                                                <strong>{{ control.title }}</strong>
                                                <br><small class="text-muted">{{ control.category }}</small>
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div id="no-results" class="alert alert-warning mt-2" style="display: none;">
                                <i class="fas fa-search me-2"></i>No se encontraron controles que coincidan con la búsqueda.
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                No hay controles SOA aplicables disponibles.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Botones -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('audits.audits_list') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check me-1"></i>{{ 'Actualizar' if audit else 'Crear' }} Auditoría
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel Lateral -->
            <div class="col-md-4">
                <!-- Guía ISO 27001 -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-book me-2"></i>
                            Guía ISO 27001:2022
                        </h6>
                    </div>
                    <div class="card-body">
                        <h6>Cláusula 9.2 - Auditoría Interna</h6>
                        <p class="small mb-2">La organización debe realizar auditorías internas a intervalos planificados para:</p>
                        <ul class="small mb-3">
                            <li>Verificar conformidad con requisitos propios y ISO 27001</li>
                            <li>Evaluar eficacia del SGSI</li>
                            <li>Implementar y mantener eficazmente el SGSI</li>
                        </ul>

                        <h6>Elementos Clave</h6>
                        <ul class="small mb-0">
                            <li>Alcance claro y definido</li>
                            <li>Criterios objetivos</li>
                            <li>Equipo competente e independiente</li>
                            <li>Documentación de resultados</li>
                            <li>Seguimiento de hallazgos</li>
                        </ul>
                    </div>
                </div>

                <!-- Checklist -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            Checklist de Planificación
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="chk1">
                            <label class="form-check-label small" for="chk1">
                                Tipo de auditoría definido
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="chk2">
                            <label class="form-check-label small" for="chk2">
                                Alcance claro y específico
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="chk3">
                            <label class="form-check-label small" for="chk3">
                                Auditor líder calificado
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="chk4">
                            <label class="form-check-label small" for="chk4">
                                Independencia verificada
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="chk5">
                            <label class="form-check-label small" for="chk5">
                                Fechas planificadas
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="chk6">
                            <label class="form-check-label small" for="chk6">
                                Áreas/controles identificados
                            </label>
                        </div>
                    </div>
                </div>

                {% if audit %}
                <!-- Estado Actual -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-info me-2"></i>
                            Estado Actual
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <strong>Código:</strong> {{ audit.audit_code }}
                        </div>
                        <div class="mb-2">
                            <strong>Estado:</strong>
                            <span class="badge bg-{{ 'secondary' if audit.status.name == 'PLANNED' else 'info' }}">
                                {{ audit.status.value }}
                            </span>
                        </div>
                        <div class="mb-2">
                            <strong>Creada:</strong>
                            {{ audit.created_at.strftime('%d/%m/%Y %H:%M') }}
                        </div>
                        <div>
                            <strong>Por:</strong>
                            {{ audit.created_by.full_name if audit.created_by else 'N/A' }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='vendor/select2/select2.min.js') }}"></script>
<script>
    $(document).ready(function() {
        // Inicializar Select2
        $('.select2').select2({
            theme: 'bootstrap-5',
            width: '100%'
        });

        // Validación de fechas
        $('#start_date').on('change', function() {
            $('#end_date').attr('min', this.value);
        });

        $('#end_date').on('change', function() {
            const startDate = $('#start_date').val();
            if (startDate && this.value < startDate) {
                alert('La fecha de fin debe ser posterior a la fecha de inicio');
                this.value = '';
            }
        });

        // Auto-actualizar checklist
        $('input[required], textarea[required], select[required]').on('blur change', function() {
            updateChecklist();
        });

        function updateChecklist() {
            $('#chk1').prop('checked', $('#audit_type').val() !== '');
            $('#chk2').prop('checked', $('#scope').val().length > 20);
            $('#chk3').prop('checked', $('#lead_auditor_id').val() !== '');
            $('#chk5').prop('checked', $('#planned_date').val() !== '' || $('#start_date').val() !== '');
            $('#chk6').prop('checked', $('.control-checkbox:checked').length > 0);
        }

        // ============================================
        // Sistema de filtrado de controles
        // ============================================
        const filterInput = document.getElementById('control-filter');
        const controlItems = document.querySelectorAll('.control-item');
        const controlCheckboxes = document.querySelectorAll('.control-checkbox');
        const selectedCount = document.getElementById('selected-count');
        const noResults = document.getElementById('no-results');

        // Función para actualizar el contador de seleccionados
        function updateSelectedCount() {
            const checked = document.querySelectorAll('.control-checkbox:checked').length;
            if (selectedCount) {
                selectedCount.textContent = checked;
            }
            updateChecklist();
        }

        // Filtro de controles
        if (filterInput) {
            filterInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                let visibleCount = 0;

                controlItems.forEach(item => {
                    const controlText = item.getAttribute('data-control-text');

                    if (controlText.includes(searchTerm)) {
                        item.style.display = '';
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                // Mostrar/ocultar mensaje de sin resultados
                if (noResults) {
                    if (visibleCount === 0 && searchTerm !== '') {
                        noResults.style.display = 'block';
                    } else {
                        noResults.style.display = 'none';
                    }
                }
            });
        }

        // Actualizar contador cuando se marcan/desmarcan checkboxes
        controlCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });

        // Inicializar contador
        updateSelectedCount();
    });
</script>
{% endblock %}

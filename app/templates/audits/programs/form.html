{% extends "base.html" %}
{% block title %}{{ 'Editar' if program else 'Nuevo' }} Programa de Auditoría - ISO 27001{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>
                <i class="fas fa-calendar-alt me-2"></i>
                {{ 'Editar Programa de Auditoría' if program else 'Nuevo Programa de Auditoría' }}
            </h2>
            <p class="text-muted">
                ISO 27001:2022 - Cláusula 9.2.2 - Programa de auditoría interna
            </p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('audits.programs_list') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
        </div>
    </div>

    <!-- Formulario -->
    <form method="POST" action="{{ url_for('audits.program_create') if not program else url_for('audits.program_edit', id=program.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="row">
            <!-- Información Básica -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Información del Programa
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="year" class="form-label">Año <span class="text-danger">*</span></label>
                                <input type="number"
                                       class="form-control"
                                       id="year"
                                       name="year"
                                       min="{{ datetime.now().year }}"
                                       max="{{ datetime.now().year + 5 }}"
                                       value="{{ program.year if program else datetime.now().year }}"
                                       required>
                                <small class="form-text text-muted">Año del programa</small>
                            </div>
                            <div class="col-md-9 mb-3">
                                <label for="title" class="form-label">Título <span class="text-danger">*</span></label>
                                <input type="text"
                                       class="form-control"
                                       id="title"
                                       name="title"
                                       value="{{ program.title if program else '' }}"
                                       placeholder="Ej: Programa Anual de Auditorías Internas 2025"
                                       required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Descripción</label>
                            <textarea class="form-control"
                                      id="description"
                                      name="description"
                                      rows="3"
                                      placeholder="Descripción general del programa de auditorías">{{ program.description if program else '' }}</textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="start_date" class="form-label">Fecha Inicio <span class="text-danger">*</span></label>
                                <input type="date"
                                       class="form-control"
                                       id="start_date"
                                       name="start_date"
                                       value="{{ program.start_date.strftime('%Y-%m-%d') if program and program.start_date else '' }}"
                                       required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="end_date" class="form-label">Fecha Fin <span class="text-danger">*</span></label>
                                <input type="date"
                                       class="form-control"
                                       id="end_date"
                                       name="end_date"
                                       value="{{ program.end_date.strftime('%Y-%m-%d') if program and program.end_date else '' }}"
                                       required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="scope" class="form-label">Alcance <span class="text-danger">*</span></label>
                            <textarea class="form-control"
                                      id="scope"
                                      name="scope"
                                      rows="4"
                                      placeholder="Define el alcance del programa de auditorías (áreas, procesos, controles ISO 27001 a auditar)"
                                      required>{{ program.scope if program else '' }}</textarea>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Incluir áreas organizacionales, procesos clave y controles del Anexo A de ISO 27001
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="objectives" class="form-label">Objetivos del Programa <span class="text-danger">*</span></label>
                            <textarea class="form-control"
                                      id="objectives"
                                      name="objectives"
                                      rows="5"
                                      placeholder="Lista los objetivos del programa (uno por línea)&#10;Ej:&#10;- Verificar cumplimiento de controles ISO 27001&#10;- Evaluar eficacia del SGSI&#10;- Identificar oportunidades de mejora"
                                      required>{{ program.objectives if program else '' }}</textarea>
                            <small class="form-text text-muted">
                                <i class="fas fa-lightbulb me-1"></i>
                                Define qué se espera lograr con el programa de auditorías
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <button type="submit" name="action" value="save_draft" class="btn btn-secondary">
                                <i class="fas fa-save me-1"></i>Guardar Borrador
                            </button>
                            <div>
                                <a href="{{ url_for('audits.programs_list') }}" class="btn btn-outline-secondary me-2">
                                    <i class="fas fa-times me-1"></i>Cancelar
                                </a>
                                <button type="submit" name="action" value="save" class="btn btn-primary">
                                    <i class="fas fa-check me-1"></i>{{ 'Actualizar' if program else 'Crear' }} Programa
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel Lateral -->
            <div class="col-md-4">
                <!-- Ayuda ISO 27001 -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Requisitos ISO 27001
                        </h6>
                    </div>
                    <div class="card-body">
                        <h6>Cláusula 9.2.2 - Programa de Auditoría</h6>
                        <ul class="small mb-3">
                            <li>Planificar anualmente</li>
                            <li>Definir alcance y objetivos</li>
                            <li>Frecuencia según riesgo</li>
                            <li>Criterios de auditoría claros</li>
                            <li>Selección de auditores competentes</li>
                            <li>Cobertura mínima 80% controles</li>
                        </ul>

                        <h6 class="mt-3">Recomendaciones</h6>
                        <ul class="small mb-0">
                            <li>Auditar todos los controles implementados al menos 1 vez al año</li>
                            <li>Mayor frecuencia para controles críticos</li>
                            <li>Incluir auditorías de seguimiento</li>
                            <li>Considerar cambios en el SGSI</li>
                        </ul>
                    </div>
                </div>

                <!-- Checklist -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            Checklist del Programa
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="checklist[]" value="year_defined" id="check1"
                                   {% if program and program.checklist_data and 'year_defined' in program.checklist_data %}checked{% endif %}>
                            <label class="form-check-label small" for="check1">
                                Año y período definidos
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="checklist[]" value="scope_complete" id="check2"
                                   {% if program and program.checklist_data and 'scope_complete' in program.checklist_data %}checked{% endif %}>
                            <label class="form-check-label small" for="check2">
                                Alcance cubre SGSI completo
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="checklist[]" value="objectives_aligned" id="check3"
                                   {% if program and program.checklist_data and 'objectives_aligned' in program.checklist_data %}checked{% endif %}>
                            <label class="form-check-label small" for="check3">
                                Objetivos alineados con política
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="checklist[]" value="coverage_adequate" id="check4"
                                   {% if program and program.checklist_data and 'coverage_adequate' in program.checklist_data %}checked{% endif %}>
                            <label class="form-check-label small" for="check4">
                                Cobertura ≥ 80% controles ISO
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="checklist[]" value="auditors_available" id="check5"
                                   {% if program and program.checklist_data and 'auditors_available' in program.checklist_data %}checked{% endif %}>
                            <label class="form-check-label small" for="check5">
                                Auditores calificados disponibles
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="checklist[]" value="resources_assigned" id="check6"
                                   {% if program and program.checklist_data and 'resources_assigned' in program.checklist_data %}checked{% endif %}>
                            <label class="form-check-label small" for="check6">
                                Recursos asignados
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Estado Actual -->
                {% if program %}
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-info me-2"></i>
                            Estado Actual
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <strong>Estado:</strong>
                            {% if program.status.name == 'DRAFT' %}
                            <span class="badge bg-secondary">Borrador</span>
                            {% elif program.status.name == 'APPROVED' %}
                            <span class="badge bg-success">Aprobado</span>
                            {% endif %}
                        </div>
                        <div class="mb-2">
                            <strong>Creado:</strong>
                            {{ program.created_at.strftime('%d/%m/%Y %H:%M') }}
                        </div>
                        <div class="mb-2">
                            <strong>Por:</strong>
                            {{ program.created_by.full_name if program.created_by else 'N/A' }}
                        </div>
                        {% if program.approved_by %}
                        <div class="mb-2">
                            <strong>Aprobado por:</strong>
                            {{ program.approved_by.full_name }}
                        </div>
                        <div>
                            <strong>Fecha aprobación:</strong>
                            {{ program.approval_date.strftime('%d/%m/%Y') }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Validación de fechas
    document.getElementById('start_date').addEventListener('change', function() {
        const endDate = document.getElementById('end_date');
        endDate.min = this.value;
    });

    document.getElementById('end_date').addEventListener('change', function() {
        const startDate = document.getElementById('start_date');
        if (this.value < startDate.value) {
            alert('La fecha de fin debe ser posterior a la fecha de inicio');
            this.value = '';
        }
    });

    // Auto-generar título si está vacío
    document.getElementById('year').addEventListener('change', function() {
        const titleInput = document.getElementById('title');
        if (!titleInput.value) {
            titleInput.value = `Programa Anual de Auditorías Internas ${this.value}`;
        }
    });

    // Actualizar checklist
    const formInputs = document.querySelectorAll('input[required], textarea[required]');
    formInputs.forEach((input, index) => {
        input.addEventListener('blur', function() {
            const checkbox = document.getElementById(`check${index + 1}`);
            if (checkbox && this.value.trim()) {
                checkbox.checked = true;
            }
        });
    });
</script>
{% endblock %}

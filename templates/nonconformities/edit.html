{% extends "base.html" %}

{% block title %}Editar No Conformidad {{ nc.nc_number }} - SGSI{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-edit text-warning"></i>
                        Editar No Conformidad {{ nc.nc_number }}
                    </h1>
                    <p class="text-muted mb-0">
                        <small>ISO 27001:2023 - Cap铆tulo 10.2 | Modificaci贸n de datos b谩sicos</small>
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('nonconformities.view', id=nc.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert de estado actual -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Estado actual:</strong>
                <span class="badge bg-primary ms-2">{{ nc.status.value }}</span>
                <span class="ms-3">
                    <strong>Severidad:</strong>
                    <span class="badge bg-{{ 'danger' if nc.severity.name == 'CRITICAL' else 'warning' if nc.severity.name == 'MAJOR' else 'info' }} ms-2">
                        {{ nc.severity.value }}
                    </span>
                </span>
            </div>
        </div>
    </div>

    <!-- Formulario de edici贸n -->
    <div class="card">
        <div class="card-body">
            <form method="POST" action="{{ url_for('nonconformities.edit', id=nc.id) }}" id="editForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <!-- Secci贸n: Informaci贸n B谩sica -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-file-alt text-primary"></i>
                            Informaci贸n B谩sica
                        </h5>
                    </div>

                    <div class="col-md-12 mb-3">
                        <label for="title" class="form-label required">T铆tulo *</label>
                        <input type="text" class="form-control" id="title" name="title"
                               value="{{ nc.title }}" required maxlength="255"
                               placeholder="Ej: Falta de control de acceso en servidor de producci贸n">
                        <div class="form-text">Descripci贸n breve y clara de la no conformidad</div>
                    </div>

                    <div class="col-md-12 mb-3">
                        <label for="description" class="form-label required">Descripci贸n Detallada *</label>
                        <textarea class="form-control" id="description" name="description"
                                  rows="5" required
                                  placeholder="Describa la no conformidad en detalle">{{ nc.description }}</textarea>
                        <div class="form-text">Proporcione todos los detalles relevantes (10.2.f - naturaleza de la no conformidad)</div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="origin" class="form-label required">Origen *</label>
                        <select class="form-select" id="origin" name="origin" required>
                            {% for origin in NCOrigin %}
                            <option value="{{ origin.name }}" {% if nc.origin == origin %}selected{% endif %}>
                                {{ origin.value }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="severity" class="form-label required">Severidad *</label>
                        <select class="form-select" id="severity" name="severity" required>
                            {% for severity in NCSeverity %}
                            <option value="{{ severity.name }}" {% if nc.severity == severity %}selected{% endif %}>
                                {{ severity.value }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <small>
                                <strong>Menor:</strong> Bajo impacto<br>
                                <strong>Mayor:</strong> Impacto significativo<br>
                                <strong>Cr铆tica:</strong> Impacto grave en el SGSI
                            </small>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="detection_date" class="form-label required">Fecha de Detecci贸n *</label>
                        <input type="datetime-local" class="form-control" id="detection_date"
                               name="detection_date" required
                               value="{{ nc.detection_date.strftime('%Y-%m-%dT%H:%M') if nc.detection_date else '' }}">
                    </div>
                </div>

                <!-- Secci贸n: Responsabilidades y Fechas -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-users text-primary"></i>
                            Responsabilidades y Fechas
                        </h5>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="responsible_id" class="form-label required">Responsable *</label>
                        <select class="form-select" id="responsible_id" name="responsible_id" required>
                            {% for user in users %}
                            <option value="{{ user.id }}" {% if nc.responsible_id == user.id %}selected{% endif %}>
                                {{ user.name }} - {{ user.position or '' }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Persona responsable de gestionar esta NC</div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="target_closure_date" class="form-label">Fecha Objetivo de Cierre</label>
                        <input type="date" class="form-control" id="target_closure_date"
                               name="target_closure_date"
                               value="{{ nc.target_closure_date.strftime('%Y-%m-%d') if nc.target_closure_date else '' }}">
                        <div class="form-text">Fecha prevista para resolver la NC</div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label">D铆as Abierta</label>
                        <input type="text" class="form-control" readonly
                               value="{{ nc.calculate_days_open() }} d铆as">
                    </div>
                </div>

                <!-- Secci贸n: Acci贸n Inmediata -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-bolt text-primary"></i>
                            Acci贸n Inmediata (ISO 10.2.a)
                        </h5>
                    </div>

                    <div class="col-md-12 mb-3">
                        <label for="immediate_action" class="form-label">Acci贸n Inmediata Tomada</label>
                        <textarea class="form-control" id="immediate_action" name="immediate_action"
                                  rows="3"
                                  placeholder="Describa cualquier acci贸n inmediata que se haya tomado para controlar la situaci贸n (ISO 10.2.a)">{{ nc.immediate_action or '' }}</textarea>
                        <div class="form-text">10.2.a - Acciones para controlar y corregir</div>
                    </div>
                </div>

                <!-- Secci贸n: Contexto y Relaciones -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-sitemap text-primary"></i>
                            Contexto y Relaciones
                        </h5>
                    </div>

                    <div class="col-md-12 mb-3">
                        <label class="form-label">Controles ISO 27001 Afectados</label>

                        {% if controls %}
                        <!-- Filtro de controles -->
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" id="control-filter"
                                   placeholder=" Buscar controles por ID, t铆tulo o categor铆a...">
                        </div>

                        <!-- Contador de controles -->
                        <div class="mb-2">
                            <small class="text-muted">
                                <span id="selected-count">0</span> controles seleccionados de
                                <span id="total-count">{{ controls|length }}</span>
                            </small>
                        </div>

                        <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;" id="controls-container">
                            <div class="row" id="controls-list">
                                {% for control in controls %}
                                <div class="col-md-12 mb-2 control-item" data-control-text="{{ control.control_id|lower }} {{ control.title|lower }} {{ control.category|lower }}">
                                    <div class="form-check">
                                        <input class="form-check-input control-checkbox" type="checkbox"
                                               name="affected_controls" value="{{ control.control_id }}"
                                               id="control_{{ control.id }}"
                                               {% if control.control_id in nc.affected_controls %}checked{% endif %}>
                                        <label class="form-check-label" for="control_{{ control.id }}" style="cursor: pointer;">
                                            <code class="text-primary">{{ control.control_id }}</code>
                                            <strong>{{ control.title }}</strong>
                                            <br><small class="text-muted">{{ control.category }}</small>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div id="no-results" class="alert alert-warning mt-2" style="display: none;">
                            <i class="fas fa-search me-2"></i>No se encontraron controles que coincidan con la b煤squeda.
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No hay controles SOA disponibles. Primero debe crear una versi贸n SOA e importar controles.
                        </div>
                        {% endif %}

                        <div class="form-text">Seleccione los controles del Anexo A que est谩n afectados</div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="audit_id" class="form-label">Auditor铆a Relacionada</label>
                        <select class="form-select" id="audit_id" name="audit_id">
                            <option value="">Ninguna</option>
                            {% for audit in audits %}
                            <option value="{{ audit.id }}" {% if nc.audit_id == audit.id %}selected{% endif %}>
                                {{ audit.title }} - {{ audit.audit_type }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Si la NC proviene de una auditor铆a</div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">Activos Afectados</label>
                        <select class="form-select" id="asset_ids" name="asset_ids" multiple size="5">
                            {% for asset in assets %}
                            <option value="{{ asset.id }}"
                                {% for nc_asset in nc.affected_assets %}
                                    {% if nc_asset.asset_id == asset.id %}selected{% endif %}
                                {% endfor %}>
                                {{ asset.asset_code }} - {{ asset.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Mantenga Ctrl/Cmd para selecci贸n m煤ltiple</div>
                    </div>

                    <div class="col-md-12 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_recurrent"
                                   name="is_recurrent" onchange="toggleRecurrent()"
                                   {% if nc.is_recurrent %}checked{% endif %}>
                            <label class="form-check-label" for="is_recurrent">
                                <strong>Es una NC recurrente</strong>
                                <small class="text-muted">(10.2.b.3 - NC similares)</small>
                            </label>
                        </div>
                    </div>

                    <div class="col-md-12 mb-3 {% if not nc.is_recurrent %}d-none{% endif %}" id="recurrent_section">
                        <label for="related_nc_id" class="form-label">NC Anterior Relacionada</label>
                        <input type="text" class="form-control" id="related_nc_id" name="related_nc_id"
                               placeholder="Ingrese el c贸digo de la NC anterior"
                               value="{{ nc.related_nc_id or '' }}">
                    </div>

                    <div class="col-md-12 mb-3">
                        <label for="notes" class="form-label">Notas Adicionales</label>
                        <textarea class="form-control" id="notes" name="notes"
                                  rows="3" placeholder="Cualquier informaci贸n adicional relevante">{{ nc.notes or '' }}</textarea>
                    </div>
                </div>

                <!-- Botones de acci贸n -->
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('nonconformities.view', id=nc.id) }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Informaci贸n de modificaci贸n -->
    <div class="card mt-3 border-info">
        <div class="card-header bg-info text-white">
            <h6 class="mb-0">
                <i class="fas fa-info-circle"></i> Informaci贸n de cambios
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1">
                        <strong>Creada por:</strong> {{ nc.created_by.name if nc.created_by else 'N/A' }}
                    </p>
                    <p class="mb-1">
                        <strong>Fecha de creaci贸n:</strong>
                        {{ nc.created_at.strftime('%d/%m/%Y %H:%M') if nc.created_at else 'N/A' }}
                    </p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1">
                        <strong>ltima modificaci贸n:</strong>
                        {{ nc.updated_at.strftime('%d/%m/%Y %H:%M') if nc.updated_at else 'N/A' }}
                    </p>
                    <p class="mb-0 text-muted">
                        <small>
                            <i class="fas fa-clock"></i>
                            Los cambios se registrar谩n en el timeline de la NC
                        </small>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Advertencias importantes -->
    <div class="alert alert-warning mt-3">
        <h6><i class="fas fa-exclamation-triangle"></i> Importante</h6>
        <ul class="mb-0">
            <li>Los cambios realizados quedar谩n registrados en el historial de eventos (ISO 7.5.3)</li>
            <li>No se puede modificar el n煤mero de NC ni el estado desde este formulario</li>
            <li>Para cambiar el estado, use el formulario espec铆fico en la vista de detalle</li>
            <li>Los cambios en los controles afectados pueden requerir actualizaci贸n del an谩lisis de impacto</li>
        </ul>
    </div>
</div>

<script>
    function toggleRecurrent() {
        const checkbox = document.getElementById('is_recurrent');
        const section = document.getElementById('recurrent_section');

        if (checkbox.checked) {
            section.classList.remove('d-none');
        } else {
            section.classList.add('d-none');
        }
    }

    // Form validation
    document.getElementById('editForm').addEventListener('submit', function(e) {
        const form = this;
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        form.classList.add('was-validated');
    });

    // Confirmaci贸n antes de salir con cambios sin guardar
    let formChanged = false;
    const form = document.getElementById('editForm');
    const originalData = new FormData(form);

    form.addEventListener('change', function() {
        formChanged = true;
    });

    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    form.addEventListener('submit', function() {
        formChanged = false;
    });
</script>

<style>
    .required::after {
        content: " *";
        color: red;
    }

    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }

    .border-bottom {
        border-bottom: 2px solid #dee2e6 !important;
    }

    h5 i {
        width: 20px;
    }
</style>

<script>
// Filtrado de controles
document.addEventListener('DOMContentLoaded', function() {
    const filterInput = document.getElementById('control-filter');
    const controlItems = document.querySelectorAll('.control-item');
    const controlCheckboxes = document.querySelectorAll('.control-checkbox');
    const selectedCount = document.getElementById('selected-count');
    const noResults = document.getElementById('no-results');

    // Funci贸n para actualizar el contador de seleccionados
    function updateSelectedCount() {
        const checked = document.querySelectorAll('.control-checkbox:checked').length;
        if (selectedCount) {
            selectedCount.textContent = checked;
        }
    }

    // Filtro de controles
    if (filterInput) {
        filterInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            let visibleCount = 0;

            controlItems.forEach(item => {
                const controlText = item.getAttribute('data-control-text');

                if (controlText.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // Mostrar/ocultar mensaje de "no results"
            if (noResults) {
                if (visibleCount === 0 && searchTerm !== '') {
                    noResults.style.display = 'block';
                } else {
                    noResults.style.display = 'none';
                }
            }
        });
    }

    // Actualizar contador cuando se marcan/desmarcan checkboxes
    controlCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });

    // Inicializar contador
    updateSelectedCount();
});
</script>
{% endblock %}
